<h1 id="WritingMPFVersionConverter-Introduction">Introduction</h1><p>When one of the type files are changed (in contrib/libmtypes/src/type_files directory), the &quot;globalSchemaVersion&quot; attribute in SW_AdmProjectRoot.json must be incremented. The &quot;mpf&quot; files will be written with this new globalSchemaVersion. The developer must write a converter to convert the previous version to the current version. This document will show the steps to create a new version converter. Currently the converter is in the Ncore3 branch.Â </p><h1 id="WritingMPFVersionConverter-SourceFiles">Source Files</h1><p>All the source files are located in <strong><code>contrib/libdm/src/json/converter/json</code></strong> directory. In this example, let's assume the current globalSchemaVersion is 4 and the new version is 5. First is to setup the JSONConverterManager. Then write the converter.</p><h3 id="WritingMPFVersionConverter-AddingconvertertoJSONConverterManager">Adding converter to JSONConverterManager</h3><ul><li>Add converter's include file to header.</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: cpp; gutter: false; theme: Confluence" data-theme="Confluence">#include &quot;jsonconverter/json/Convert_04_05.h&quot;</pre>
</div></div><ul><li>Add converter to manager.</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: cpp; gutter: false; theme: Confluence" data-theme="Confluence">builder.add(std::make_shared&lt;GenericConverter&gt;(Version(4), Version(5), json::v04_05::Convert_04_05));</pre>
</div></div><h3 id="WritingMPFVersionConverter-Creatingtheconverter">Creating the converter</h3><p>Here is a template to write the converter. Replace &quot;<strong><code>/*&lt;oldVersion&gt;*/</code></strong>&quot; with &quot;04&quot; and &quot;<code><strong>/*&lt;newVersion&gt;*/</strong></code>&quot; with &quot;05 for this example.</p><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: cpp; gutter: false; theme: Confluence" data-theme="Confluence">#pragma once

#include &lt;jsonconverter/json/JSONConverterManager.h&gt;
#include &lt;jsonconverter/json/JSONManipulators.h&gt;
#include &quot;jsonconverter/json/JSONCommon.h&quot;
#include &quot;VersionManager.h&quot;

#include &lt;rapidjson/document.h&gt;
#include &lt;rapidjson/pointer.h&gt;
#include &lt;rapidjson/stringbuffer.h&gt;
#include &lt;rapidjson/error/en.h&gt;
#include &lt;rapidjson/allocators.h&gt;

#include &lt;boost/optional.hpp&gt;
#include &lt;functional&gt;
#include &lt;queue&gt;
#include &lt;utility&gt;
#include &lt;tuple&gt;

namespace maestro {
namespace jsonconverter {

namespace json {

namespace v/*&lt;oldVersion&gt;*/_/*&lt;newVersion&gt;*/ { // v04_05

/// @brief Upgrade Schema ver. &lt;oldVersion&gt; to &lt;newVersion&gt;.
///
//
using namespace rapidjson;

static bool updateClockSubdomain(rapidjson::Document &amp;doc, rapidjson::Value &amp;node) {
  renameVecT rename = {
               std::make_pair(&quot;divideBy&quot;, &quot;divideBy&quot;),
               std::make_pair(&quot;divideBy&quot;, &quot;divideBy&quot;) };
  return renameAttributes(doc, node, rename);
}

Result Convert_/*&lt;oldVersion&gt;*/_/*&lt;newVersion&gt;*/(detail::data_wrapper&lt;Data&gt; data) { // Convert_04_05
  using namespace rapidjson;
  Status status = Status::OK;
  rapidjson::Document&amp; doc = data;
  static constexpr Version kOldVersion(/*&lt;oldVersion&gt;*); //04
  static constexpr Version kNewVersion(/*&lt;newVersion&gt;*); //05

  uint64_t docSchema = datamodel::VersionManager::getGlobalSchemaVersion(doc);
  if (docSchema != kOldVersion.base()) {
    RETURN_OLDVERSION(status, data, kOldVersion, __LINE__);
  }

  msg::Msg::Info(msg::PkgTag::DM, 18,
                 &quot;MPF conversion: from version %1% to %2%&quot;
               , kOldVersion.base(), kNewVersion.base());

  //
  // Conversion code begins below this line
  //

  // --- Process clkregions.clockdomains.domains ----
  std::string clockSubdomainStr(&quot;pf.main.chips.*.clkregions.clockdomains.domains&quot;);
  if (!registerChange(doc, clockSubdomainStr, updateClockSubdomain)) {
    RETURN_OLDVERSION(status, data, kOldVersion, __LINE__);
  }

  //
  // Do not edit below this line
  //
  OptionalValueRef ref = GetPath(doc, &quot;/main&quot;);
  if (ref) {
    Value &amp;main = (*ref).get();
    if (!rename_productVersion(doc, main)) {
      RETURN_OLDVERSION(status, data, kOldVersion, __LINE__);
    }
  }

  if (status == Status::OK) {
      if (!datamodel::VersionManager::writeGlobalSchemaVersion(doc)) {
      status = Status::ERROR;
    }

    if (!datamodel::VersionManager::writeProductVersion(doc)) {
      status = Status::ERROR;
    }
  }
  Version version = status == Status::OK ? kNewVersion : kOldVersion;

  return Result(std::move(data), version, status);
}

} // namespace v04_05

} // namespace json

} // namespace jsonconverter
} // namespace maestro</pre>
</div></div><p>For more details on how to traverse the mpf json's hierarchy, refer to &quot;Convert_01_04.h&quot; for more examples.</p><p><br/></p><p><br/></p>