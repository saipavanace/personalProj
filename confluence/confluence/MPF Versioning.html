<div class="contentLayout2"><style>[data-colorid=kwbuztji23]{color:#333333} html[data-color-mode=dark] [data-colorid=kwbuztji23]{color:#cccccc}</style>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><style type="text/css">/*<![CDATA[*/
div.rbtoc1759723317543 {padding: 0px;}
div.rbtoc1759723317543 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1759723317543 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style></p><div class="toc-macro rbtoc1759723317543">
<ul class="toc-indentation">
<li><a href="#MPFVersioning-TerminologyandDefinitions">Terminology and Definitions</a>
<ul class="toc-indentation">
<li><a href="#MPFVersioning-TypeFilesVersions">Type Files Versions</a>
<ul class="toc-indentation">
<li><a href="#MPFVersioning-IndividualTypeFileVersion">Individual Type File Version</a></li>
<li><a href="#MPFVersioning-GlobalTypeFiles(Schema)Version">Global Type Files (Schema) Version</a></li>
<li><a href="#MPFVersioning-SignificantvsInsignificantTypeFileChanges">Significant vs Insignificant Type File Changes</a></li>
</ul>
</li>
<li><a href="#MPFVersioning-MPFFileFormatVersioning">MPF File Format Versioning</a></li>
<li><a href="#MPFVersioning-ADM_VERSION">ADM_VERSION</a></li>
</ul>
</li>
<li><a href="#MPFVersioning-AutomaticTypeFilesVersionManagement">Automatic Type Files Version Management</a>
<ul class="toc-indentation">
<li><a href="#MPFVersioning-Notesonautomatictypefilesversionsmanagementduringmerge">Notes on automatic type files versions management during merge</a></li>
</ul>
</li>
<li><a href="#MPFVersioning-ForVersioningScriptMaintainers">For Versioning Script Maintainers</a>
<ul class="toc-indentation">
<li><a href="#MPFVersioning-ScriptUnitTests">Script Unit Tests</a></li>
</ul>
</li>
<li><a href="#MPFVersioning-TypeFilesConverter">Type Files Converter</a></li>
<li><a href="#MPFVersioning-FAQ">FAQ</a></li>
</ul>
</div><p /></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="MPFVersioning-TerminologyandDefinitions">Terminology and Definitions</h1></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="MPFVersioning-TypeFilesVersions">Type Files Versions</h2><p>Type Files are json files that describe Maestro data schema (objects, their type and parameters). Type files are located in&nbsp;<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/tree/develop/contrib/libmtypes/src/type_files" rel="nofollow">maestro/contrib/libmtypes/src/type_files/</a>.</p><p>A Type File is a representation of a Maestro object that is used during project serialization and deserialization (saving the Maestro project to disk as an .mpf file and loading it from disk). If an object representation in an .mpf file is different from the representation known to Maestro, Maestro won't be able to load the object and may even crash. To address this issue, Type Files Versioning and Type Files Json Converter were introduced.</p><p>Type Files (Data Format) versioning consists of two parts: individual type (file) versions and g<span>lobal type files version (also referred to as global schema version or global data format version) </span>.</p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h3 id="MPFVersioning-IndividualTypeFileVersion">Individual Type File Version</h3><p><span>Every type file has its own version &ndash;&nbsp;a single integer that is usually placed at the bottom of the corresponding type file. For example, this sample type file has version 1 (see </span><span class="legacy-color-text-blue2"><code>&quot;version&quot;: 1</code></span> below)<span>:<br /></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
    &quot;type&quot;: &quot;SomeType&quot;,
    &quot;baseType&quot;: &quot;COMMON_ObjectBase&quot;,
    &quot;members&quot;: {
        &quot;someMember&quot;: {
            &quot;kind&quot;: &quot;Variable&quot;,
            &quot;type&quot;: &quot;SomeOtherType&quot;,
            &quot;title&quot;: &quot;Member Title&quot;,
            &quot;readOnly&quot;: false,
            &quot;userVisible&quot;: true
        }
    },
    &quot;version&quot;: 1
}</pre>
</div></div><p><span class="auto-cursor-target"><span>This version should be incremented every time a type file is significantly changed.&nbsp;By a &quot;significant change&quot; we understand any change that can break compatibility of .mpf files (see details in <a href="https://arterisip.atlassian.net/wiki/spaces/ENGR/pages/16155697/MPF+Versioning#MPFVersioning-SignificantvsInsignificantTypeFileChanges">Significant vs Insignificant Type File Changes</a>).</span></span></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h3 id="MPFVersioning-GlobalTypeFiles(Schema)Version"><span class="auto-cursor-target"><span>Global Type Files (Schema) Version</span></span></h3><p><span class="auto-cursor-target"><span>Global Type Files (Schema) Version defines a common version for all the data types we have in type files (all the data types that an .mpf file may contain). It is represented as an integer. The global data schema version is defined in the SW_AdmProjectRoot.json type file. For example, Global Type Files version value is 4 below:</span></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">&quot;members&quot;: {
        &quot;globalSchemaVersion&quot;: {
            &quot;kind&quot;: &quot;Variable&quot;,
            &quot;type&quot;: &quot;Integer&quot;,
            &quot;title&quot;: &quot;Global Type Files Version&quot;,
            &quot;default&quot;: 4,
            &quot;readOnly&quot;: true,
            &quot;userVisible&quot;: false,
            &quot;description&quot;: &quot;Global version for all the type files. Its 'default' value is compared to the corresponding value stored in an .mpf file before opening it (together with product version). The 'default' is automatically incremented every time any type files is significantly changed.&quot;
        },
        ...
}</pre>
</div></div><p><span class="auto-cursor-target">This version should be incremented every time any type file is significantly changed, added, removed or renamed. By a &quot;significant change&quot; we understand any change that can break compatibility of .mpf files (<span>see details in <a href="https://arterisip.atlassian.net/wiki/spaces/ENGR/pages/16155697/MPF+Versioning#MPFVersioning-SignificantvsInsignificantTypeFileChanges">Significant vs Insignificant Type File Changes</a></span>).</span></p><p><span class="auto-cursor-target">Maestro checks&nbsp;</span>this version along with the product version&nbsp;<span class="auto-cursor-target">before loading data from an .mpf file (see&nbsp;<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/blob/master/contrib/libdm/src/ParameterFacetIO.cc#L376" rel="nofollow">http://gitlab.arteris.com/maestro/maestro/blob/master/contrib/libdm/src/ParameterFacetIO.cc#L376</a>).</span></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h3 id="MPFVersioning-SignificantvsInsignificantTypeFileChanges">Significant vs Insignificant Type File Changes</h3><p><span class="auto-cursor-target">By a &quot;significant change&quot; we understand any change that can break compatibility of .mpf files (e.g. when we change a type of a member property, add or remove type members (parameters), rename a type, etc.). An &quot;insignificant change&quot; is a change that does not break .mpf files compatibility (e.g. when we change such fields as &quot;description&quot;, &quot;docID&quot; and some others).</span></p><p><span class="auto-cursor-target">In practice, we define a set of fields that can be updated without breaking .mpf files compatibility (&quot;title&quot;, &quot;decription&quot;, &quot;docID&quot; and some others, see the list <a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/blob/master/scripts/git-hooks/pre-commit-hooks/type_files_versions_check.py#L43" rel="nofollow">here</a>). All the other changes to a type file are considered significant.</span></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="MPFVersioning-MPFFileFormatVersioning">MPF File Format Versioning</h2><p>MPF File Format Version defines an .mpf file encoding, compression and encryption. That is, it defines the .mpf container version and has nothing to do with its contents.</p><p>For details please refer to&nbsp;<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/tree/master/contrib/fileutils" rel="nofollow">http://gitlab.arteris.com/maestro/maestro/tree/master/contrib/fileutils</a></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="MPFVersioning-ADM_VERSION">ADM_VERSION</h2><p><span class="status-macro aui-lozenge aui-lozenge-visual-refresh aui-lozenge-current">RESERVED FOR FUTURE</span></p><p><code>ADM_VERSION</code> is intended to be used by C++ converter. It also introduces a new namespace inside <code>maestro::adm</code>. At the moment this version is not used and is reserved for the future (C++ ADM converter in particular). See <a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/tree/master/contrib/libadmconverter" rel="nofollow">libadmconverter</a> for more details.</p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="MPFVersioning-AutomaticTypeFilesVersionManagement"><span class="auto-cursor-target">Automatic Type Files Version Management</span></h1><p><span class="auto-cursor-target"><span>In order to simplify handling of type files versioning <strong>a separate script was introduced that</strong></span></span><strong>&nbsp;is automatically run as a pre-commit git hook.</strong></p><p><span>The script does the following:</span></p><ul><li>checks every existing type file that is staged for commit:<ul><li>if the file has been significantly modified, but its individual version stayed the same, <em>the script automatically increments its individual version</em>;</li></ul></li><li>checks if any type&nbsp;that is staged for commit has been added, removed or renamed;</li><li>if any type file&nbsp;that is staged for commit has been significantly modified, added, removed or renamed, the script checks the global data schema version (&quot;globalSchemaVersion&quot;);<ul><li>if the global schema version has not been modified, <em>the script increments the&nbsp;&quot;globalSchemaVersion&quot; default value in the&nbsp;</em><span class="auto-cursor-target"><span><em>SW_AdmProjectRoot.json type file</em>;</span></span></li><li><span class="auto-cursor-target"><span>if the global schema version has been updated by a developer the script doesn't change it and proceeds.</span></span></li></ul></li></ul><p><br /></p><div class="confluence-information-macro confluence-information-macro-tip"><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon" /><div class="confluence-information-macro-body"><p>In order for the script to work on your local (virtual) machine please install Python3 module <code>deepdiff</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">pip3 install deepdiff</pre>
</div></div></div></div><div class="confluence-information-macro confluence-information-macro-tip"><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon" /><div class="confluence-information-macro-body"><p><span>If for some reason the script is complaining about something that it shouldn't be complaining about, please do the following:</span></p><ul><li>use <code>git commit --no-verify</code> to skip the pre-commit hook (use it respectfully and only when you are 100% sure the script is behaving incorrectly);</li><li>file a Jira ticket to update the script accordingly.</li></ul></div></div><h2 id="MPFVersioning-Notesonautomatictypefilesversionsmanagementduringmerge">Notes on automatic type files versions management during merge</h2><p>Main merge scenarios and corresponding script behavior are described in the table on<span>&nbsp;</span><a class="external-link" href="https://arteris-my.sharepoint.com/:x:/p/nastassia_mitskevich/EQepXRlhIghLke4CrRLUKPABHMPZhfFfDj5dd4z3kWg8Xg?e=GWHTQF" rel="nofollow" style="text-decoration: none;">https://arteris-my.sharepoint.com/:x:/p/nastassia_mitskevich/EQepXRlhIghLke4CrRLUKPABHMPZhfFfDj5dd4z3kWg8Xg?e=GWHTQF</a></p><p>and in the screenshot below.</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="250" src="https://arterisip.atlassian.net/wiki/download/attachments/16155697/Screenshot%202021-03-29%20160654.png?api=v2" /></span></p><p>In order to address the case when local and global type file versions are updated to the same values in main and feature branches (while changes to the type file are different) pre-merge-commit hook has been added to both master and Ncore3 branches. The pre-merge-commit hook simply invokes pre-commit hook when normal merge takes place.</p><p>The trickiest situation is when local and global type files versions are updated to different values in feature and main branches. In this case:</p><ul><li>a developer sets some versions during conflict resolution</li><li>then if a version stayed the same as in the target merge branch,&nbsp;the script is invoked and the version is incremented</li><li>otherwise (if a developer accepted a version from source merge branch or set some new version value) the script does nothing to the version.</li></ul><p>The developers should be aware of this script behavior and resolve conflicts accordingly.</p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="MPFVersioning-ForVersioningScriptMaintainers">For Versioning Script Maintainers</h1><p>Type Files Versioning Script is located in&nbsp;<em>maestro/scripts/git-hooks/pre-commit-hooks/</em> and is called <code>type_files_versions_check.py</code> (<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/blob/develop/scripts/git-hooks/pre-commit-hooks/type_files_versions_check.py" rel="nofollow">link</a>).</p><p>The script <strong>is automatically copied to a developer's local .git/hooks folder every time Maestro is built</strong>. This is done by the code at the bottom of the root CMakeLists.txt file (see the <a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/blob/develop/CMakeLists.txt#L428" rel="nofollow">link</a>). It allows to smoothly distribute changes to the script to all the developers with no additional action required from their side.</p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="MPFVersioning-ScriptUnitTests">Script Unit Tests</h2><p>To verify the script behavior <strong>it's mandatory to run and update its unit tests</strong> that are located in&nbsp;<em>maestro/scripts/git-hooks/tests/</em> (<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/-/tree/develop/scripts/git-hooks/tests" rel="nofollow">link</a>). The tests may be disable by default. To run the tests manually:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">$ cd scripts/git-hooks/tests
$ python3 -m unittest type_files_versions_check_test.py  # To run all the tests.
$ python3 -m unittest type_files_versions_check_test.TypeFilesDiffAnalyzerTest  # To run all the tests from the given testcase.
$ python3 -m unittest type_files_versions_check_test.TypeFilesDiffAnalyzerTest.test_type_file_insignificantly_modified  # To run specific test from the specific testcase.</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-warning"><span class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" /><div class="confluence-information-macro-body"><p class="auto-cursor-target"><span data-colorid="kwbuztji23" style="letter-spacing: 0.0px;">These unit tests modify test type files, add new temporary files and work with Git Staging area. So if a test fails, it might leave something in the staging area or a modified test file in the tree. Make sure to manually revert and fix this changes if needed.</span></p></div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="MPFVersioning-TypeFilesConverter">Type Files Converter</h1><p>Please refer to&nbsp;<a href="https://arterisip.atlassian.net/wiki/spaces/ENGR/pages/16163671/Writing+MPF+Version+Converter" data-linked-resource-id="16163671" data-linked-resource-version="2" data-linked-resource-type="page">Writing MPF Version Converter</a></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br /></p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="MPFVersioning-FAQ">FAQ</h1><p><br /></p><div id="expander-1588842665" class="expand-container"><div id="expander-control-1588842665" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="https://arterisip.atlassian.net/wiki/images/icons/grey_arrow_down.png" /></span><span class="expand-control-text">Type File Versions got incremented by they should not have been</span></div><div id="expander-content-1588842665" class="expand-content"><p><span>If for some reason the script is complaining about something that it shouldn't be complaining about, please do the following:</span></p><ul><li>use <code>git commit --no-verify</code> to skip the pre-commit hook (use it respectfully and only when you are 100% sure the script is behaving incorrectly);</li><li>file a Jira ticket to update the script accordingly.</li></ul></div></div></div>
</div>
</div>
</div>