<h1 id="QOSImplementationDetails-QOS3.2">QOS 3.2</h1><p>Get in touch with RTL for uarch details. Here's initial draft from Architecture team:</p><p><a href="/wiki/spaces/ENGR/pages/16156322/QOS+Implementation+Details?preview=%2F16156322%2F16232691%2FQoS+Architecture_1.pdf"><span style="background: url('/wiki/s/-672721829/6452/d621ad2a33e27b90ca05c475b216bfab745e08a2/1000.0.0-d621ad2a33e2/_/download/resources/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-resources/images/placeholder-medium-pdf.png'); width: 333px; height: 95px; display: inline-block; padding-top: 155px; margin: 2px; border: 1px solid #ddd; text-align: center; vertical-align: text-bottom; text-decoration: none; font-size: 12px; color: #000;">QoS Architecture_1.pdf</span></a></p><h1 id="QOSImplementationDetails-QOS3.1">QOS 3.1</h1><p>QOS definition for Ncore3.1 from email:</p><p> </p><p><strong>From:</strong> Mohammed Khaleeluddin &lt;<a class="external-link" href="mailto:mohammed.khaleeluddin@arteris.com" rel="nofollow">mohammed.khaleeluddin@arteris.com</a>&gt; <br/> <strong>Sent:</strong> Friday, June 28, 2019 7:50 PM<br/> <strong>To:</strong> Sanjay Deshpande &lt;<a class="external-link" href="mailto:sanjay.deshpande@arteris.com" rel="nofollow">sanjay.deshpande@arteris.com</a>&gt;; Khaled Labib &lt;<a class="external-link" href="mailto:Khaled.Labib@arteris.com" rel="nofollow">Khaled.Labib@arteris.com</a>&gt;<br/> <strong>Cc:</strong> Shilpa Sawant &lt;<a class="external-link" href="mailto:shilpa.sawant@arteris.com" rel="nofollow">shilpa.sawant@arteris.com</a>&gt;; Nabil Masri &lt;<a class="external-link" href="mailto:nabil.masri@arteris.com" rel="nofollow">nabil.masri@arteris.com</a>&gt;; Tso-Wei Chang &lt;<a class="external-link" href="mailto:TsoWei.Chang@arteris.com" rel="nofollow">TsoWei.Chang@arteris.com</a>&gt;<br/> <strong>Subject:</strong> QOS impmentation details</p><p> </p><p>Based on the chapter 13 of arch document requirements and the meeting where we discussed what RTL is going to implement here are the details based on discussion between Nabil, Shilpa, Tso-Wei and myself.</p><p>Please comment if you see issues</p><p> </p><p>Common:</p><ol><li>QOS value to QOS bucket (priority) mapping function. The priority value is sent on the legato interface.</li><li>QOS credit implementation.</li><ol><li>Each priority will have its own set of credits</li><li>Every priority will be able to borrow credits form lower priority than its own</li><li>Every priority will have one credit reserved for itself</li><li>Credits are returned back to the priorities in a round robin fashion.</li></ol><li>Starvation implementation.</li></ol><p>Starvation mechanism can be configured in the design with parameters and the behavior can be controlled through CSR. It is implemented as two common state machines with three bits per transaction table entry. It has four phases:</p><ol><ol><li>Starvation Detection: <br/>One global counter is designed to count commands sent. Once the counter reaches a programmable threshold, an overflow bit in all valid entries which have not sent out a commands and have their protocol dependencies (Address, AXI ID etc.) resolved is set. This indicates the start of the period where the entry must make progress. The Overflow bit will be cleared if the entry sends a command. If the global counter reaches the threshold again while the overflow bit is still set, then that entry is starving because it hasn’t made progress for at least one complete period. The state machine now enters Starvation mode, the event is logged in an error register to allow an interrupt to be raised if enable</li><li>Starvation Handling: Stop servicing all requests other than the currently starved requests. The global counter will be paused in this mode. The state machine mode will be readable via CSR and software if desired can disable QOS via CSR and resume normal operation<br/>Once all the starved requests have been serviced the normal processing resumes and the global counter resumes counting.   </li><li>Timeout Detection:<br/>One global counter is designed to count cycles (it will have an option to use an external reference input to count).  Once the counter reaches a programmable threshold, the timeout overflow bit in all valid entries is set. This indicates the start of the period where the entry must make progress. The timeout overflow bit will be cleared if the entry deallocates. If the global counter reaches the threshold again while the timeout overflow bit is still set, then that entry has timed out. The event is logged in an error register to allow an interrupt to be raised if enabled</li><li>Timeout Handling:<br/>The status is logged in the CSR software will now have the option to either disable timeout and continue or treat this as a fatal error. The timeout counter will stop running, until software restarts it via CSR.</li><li>Software via CSR will also have to the option to enable both, none or only one of the starvation / timeout mechanisms described above.</li></ol></ol><p> </p><p>IOAIU:</p><ol><li>Linked list based implementation to send transactions (initial commands) out based on QOS values in age order after all other (AXID / address / read and write) dependencies are resolved</li><li>All outgoing associated messages will have the calculated priority value on SMI.</li></ol><p>CHI_AIU:</p><ol><li>Use linked list based implementation to send transactions (initial commands) out based on QOS values in age order after all other (LPID /  address / read and write) dependencies are resolved</li><li>All outgoing associated messages will have the calculated priority value on SMI.</li></ol><p>DCE:</p><ol><li>Incoming commands are stored in a skid buffer and QOS in age order is used to pick Commands form the buffer</li><li>All outgoing associated messages will have the calculated priority value on SMI.</li></ol><p>DMI:</p><ol><li>Incoming commands are stored in a skid buffer and QOS in age order is used to pick Commands form the buffer</li><ol><li>MRD buffer</li><li>NC read write command buffer (does same address checks)</li></ol><li>All outgoing associated messages will have the calculated priority value on SMI and QOS is forwarded on native interface</li></ol><p> </p><p>Parameters:</p><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"><p align="center">Name</p></td><td class="confluenceTd"><p align="center">Type</p></td><td class="confluenceTd"><p align="center">Constraint</p></td><td class="confluenceTd"><p align="center">Default</p></td><td class="confluenceTd"><p align="center">Value example</p></td><td class="confluenceTd"><p align="center">Description</p></td></tr><tr><td class="confluenceTd"><p>fnEnableQos</p></td><td class="confluenceTd"><p>Integer</p></td><td class="confluenceTd"><p>0, 1</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Enable QOS</p></td></tr><tr><td class="confluenceTd"><p>QosInfo</p></td><td class="confluenceTd"><p>Object</p></td><td class="confluenceTd"><p>Not empty if fnEanbleQos is 1</p></td><td class="confluenceTd"><p>Empty</p></td><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p>Info for QOS logic</p></td></tr><tr><td class="confluenceTd"><p>QosInfo.qosMap</p></td><td class="confluenceTd"><p>Array of strings</p></td><td class="confluenceTd"><p>The bit vectors cannot have same bits set. Bits are always contagious and start from LSB to MSB</p></td><td class="confluenceTd"><p>[]</p></td><td class="confluenceTd"><p>[16’h0780,</p><p>16’h0030,</p><p>16’h0018,</p><p>16’h0006,</p><p>16’h0001]</p></td><td class="confluenceTd"><p>Length of array defines number of buckets. Bucket 0 is LSB</p><p> </p></td></tr><tr><td class="confluenceTd"><p>QosInfo.qosCredits</p></td><td class="confluenceTd"><p>Array of integers</p></td><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p>[]</p></td><td class="confluenceTd"><p>[4,5,3,2,1]</p></td><td class="confluenceTd"><p>Credit per bucket maps to buckets in qosMap</p></td></tr><tr><td class="confluenceTd"><p>QosInfo.qosCreditsRsv</p></td><td class="confluenceTd"><p>Array of integers</p></td><td class="confluenceTd"><p>Each value has to be same or less than corresponding value in qosCredit</p></td><td class="confluenceTd"><p>[]</p></td><td class="confluenceTd"><p>[1,1,1,1,1]</p></td><td class="confluenceTd"><p>Number of credits reserved per QOS (for now this is fixed at 1 per bucket)</p></td></tr><tr><td colspan="1" class="confluenceTd">QosInfo.qosEventTh<span>reshold</span></td><td colspan="1" class="confluenceTd">Integer</td><td colspan="1" class="confluenceTd">Max 12 bit value</td><td colspan="1" class="confluenceTd">16</td><td colspan="1" class="confluenceTd">16</td><td colspan="1" class="confluenceTd">This is the reset value for starvation event counter.</td></tr><tr><td class="confluenceTd"><p>fnEnableTimeOutRef</p></td><td class="confluenceTd"><p>Integer</p></td><td class="confluenceTd"><p>0,1</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p>Used to add extra timeout reference signal input port. This will be one port per Ncore unit AIUs, DCEs and DMIs. (At top level for Ncore this may be tied to single port out of Ncore)</p></td></tr><tr><td colspan="1" class="confluenceTd">timeOutTh<span>reshold</span></td><td colspan="1" class="confluenceTd"><span>Integer</span></td><td colspan="1" class="confluenceTd"><span>Max 31 bit value</span></td><td colspan="1" class="confluenceTd">0</td><td colspan="1" class="confluenceTd">1024</td><td colspan="1" class="confluenceTd"><span>time out threshold value; counts in increments of 4K cycles.</span></td></tr></tbody></table></div><p> </p><p>All QOS logic should be wrapped around fnEnableQos except starvation logic that will always be there to be used as timeout</p><p> </p><p>CSRs:</p><p> </p><p>Starvation timeout register (always present)</p><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"><p align="center">Name</p></td><td class="confluenceTd"><p align="center">Bits</p></td><td class="confluenceTd"><p align="center">Description</p></td></tr><tr><td class="confluenceTd"><p>TimeOutThreshold</p></td><td class="confluenceTd"><p>30:0</p></td><td class="confluenceTd"><p>Time out threshold value; counts in increments of 4K cycles. if value is 0 time out is disabled.</p></td></tr><tr><td class="confluenceTd"><p>TimeOutRefEn</p></td><td class="confluenceTd"><p>31</p></td><td class="confluenceTd"><p>Set to use reference signal input instead of counting every 4k cycle (filed is visible only if  fnEnableTimeoutRef is 1).</p></td></tr></tbody></table></div><p> </p><p>Generate an uncorrectable interrupt when threshold is met this is captured in our uncorrectable error register.</p><p>The info filed can capture information like address and request type. Capture the oldest entry in the case of multiple entries hit it.  </p><p> </p><p> </p><p>Starvation QOS event register (present only when QOS is enabled)</p><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"><p align="center">Name</p></td><td class="confluenceTd"><p align="center">Bits</p></td><td class="confluenceTd"><p align="center">Description</p></td></tr><tr><td class="confluenceTd"><p>EventThreshold</p></td><td class="confluenceTd"><p>11:0</p></td><td class="confluenceTd"><p>Event threshold value counts every 16 events (command issues) if value is 0 event count is disabled (event starvation disabled, note that if we are in starvation mode then on disable will move back to normal mode).</p></td></tr><tr><td class="confluenceTd"><p> </p></td><td class="confluenceTd"><p>31:11</p></td><td class="confluenceTd"><p>Reserved</p></td></tr></tbody></table></div><p> </p><p> </p><p>Starvation status register (engineering register not visible to customers)</p><p> </p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"><p align="center">Name</p></td><td class="confluenceTd"><p align="center">Bits</p></td><td class="confluenceTd"><p align="center">Description</p></td></tr><tr><td class="confluenceTd"><p><s>TimeOutStatus</s></p></td><td class="confluenceTd"><p><s>0</s></p></td><td class="confluenceTd"><p><s>0: Normal operation</s></p><p><s>1: starvation mode</s></p></td></tr><tr><td class="confluenceTd"><p><s>TimeOutStatusCountOverflow</s></p></td><td class="confluenceTd"><p><s>3</s></p></td><td class="confluenceTd"><p><s>Timeout count overflow bit, set if the counter overflows</s></p></td></tr><tr><td class="confluenceTd"><p><s>TimeOutStatusCount</s></p></td><td class="confluenceTd"><p><s>15:4</s></p></td><td class="confluenceTd"><p><s>Count of number of times we hit timeout threshold</s></p></td></tr><tr><td class="confluenceTd"><p>EventStatus</p></td><td class="confluenceTd"><p>16</p></td><td class="confluenceTd"><p>0: Normal operation</p><p>1: Starvation mode</p></td></tr><tr><td class="confluenceTd"><p>EventStatusCountOverflow</p></td><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Timeout count overflow bit, set if the counter overflows</p></td></tr><tr><td class="confluenceTd"><p>EventStatusCount</p></td><td class="confluenceTd"><p>31:20</p></td><td class="confluenceTd"><p>Count of number of times we hit event threshold</p></td></tr></tbody></table></div><div class="table-wrap"><table class="confluenceTable"><tbody><tr><td class="confluenceTd"> </td><td class="confluenceTd"><p><strong>Mohammed Khaleeluddin  </strong>|<strong>  </strong>Senior HW Design Manager</p><p>+1 (408) 470 7300 (Office) | +1 (571) 594 2070 (Mobile) | <a class="external-link" href="mailto:mohammed.khaleeluddin@arteris.com" rel="nofollow">mohammed.khaleeluddin@arteris.com</a></p><p>ArterisIP | 595 Millich Dr Suite 200, Campbell, CA 95008, USA |  <a class="external-link" href="http://www.arteris.com/" rel="nofollow">www.arteris.com</a></p><p> </p></td></tr></tbody></table></div>