<p>This procedure will be followed whenever Ncore/Maestro is released to a customer for either RC or production releases.</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="73546af2-8926-4e5e-aa55-25bc69e9f653" class="confluenceTable"><colgroup><col/><col style="width: 223.0px;"/><col style="width: 495.0px;"/></colgroup><tbody><tr><th class="numberingColumn confluenceTh" /><th class="confluenceTh"><p><strong>Step</strong></p></th><th class="confluenceTh"><p><strong>Description</strong></p></th></tr><tr><td class="numberingColumn confluenceTd">1</td><td class="confluenceTd"><p>Create the release Jira</p></td><td class="confluenceTd"><p>Owner: program manager</p></td></tr><tr><td class="numberingColumn confluenceTd">2</td><td class="confluenceTd"><p>Identify the release name</p></td><td class="confluenceTd"><p>e.g. Ncore 3.4.3; document in the release Jira; owner: program manager</p></td></tr><tr><td class="numberingColumn confluenceTd">3</td><td class="confluenceTd"><p>Identify the Git release branch name</p></td><td class="confluenceTd"><p>Define a release branch name and document in the release Jira, e.g, Ncore3.4/release/Ncore_3.4.3; owner: software manager</p></td></tr><tr><td class="numberingColumn confluenceTd">4</td><td class="confluenceTd"><p>Identify the name of the source branch and source commit from maestro.git and m-ncore.git</p></td><td class="confluenceTd"><p>e.g. Ncore3.4/develop and &lt;SHA_ID&gt; for each repo; document in the release Jira owner: software manager</p></td></tr><tr><td class="numberingColumn confluenceTd">5</td><td class="confluenceTd"><p>Identify the release content</p></td><td class="confluenceTd"><p>This comes from the product manifest file from the last ‘green’ build of the Maestro Git branch identified above; owner: build manager</p></td></tr><tr><td class="numberingColumn confluenceTd">6</td><td colspan="2" class="confluenceTd"><h3 id="NcoreCustomerReleaseProcedure-EndofReleasePlanning-StartExecution">End of Release Planning - Start Execution</h3></td></tr><tr><td class="numberingColumn confluenceTd">7</td><td colspan="2" class="confluenceTd"><p><em>The owner for the following steps is the build manager</em></p></td></tr><tr><td class="numberingColumn confluenceTd">8</td><td colspan="2" class="confluenceTd"><p>Trigger = release build request via Teams</p><p>Confirmation = green light from all managers via Teams</p></td></tr><tr><td class="numberingColumn confluenceTd">9</td><td class="confluenceTd"><p>Create release branches in maestro.git and m-ncore.git</p></td><td class="confluenceTd"><p>Branch from the commit SHA IDs in the manifest.json file from the last green build of Maestro. Create the branch name specified in the release Jira.</p></td></tr><tr><td class="numberingColumn confluenceTd">10</td><td class="confluenceTd"><p>Update the version information files on the release branches</p></td><td class="confluenceTd"><p><strong>In maestro.git</strong>: </p><p>Update CMakeVersion.txt</p><ul><li><p>Check that <code>NCORE_VERSION_MAJOR</code>, <code>NCORE_VERSION_MINOR</code> and <code>NCORE_VERSION_PATCH</code> are correct for the release</p></li><li><p>Set <code>NCORE_VERSION_TAG</code> to any desired value, e.g. <code>RC1</code>. Only if this string is set to the empty string, the <code>NCORE_DISCLAIMER</code> will be automaticaly cleared.</p></li><li><p>CMakeVersion.txt has provisions to give an independent version number to Maestro itself, but currently the Ncore version data is copied over, so, nothing else needs to be done.</p></li><li><p>If the build automation scripts need a label, like the legacy <code>SPECIFIC_RELEASE_PRODUCT</code> , this can either be manually appended to the file or calculated instead. The algorithm is:<br/><code>NCORE_NAME.NCORE_VERSION_MAJOR.NCORE_VERSION_MINOR.pNCORE_VERSION_PATCH-NCORE_VERSION_TAG</code><br/>where the <code>.pNCORE_VERSION_PATCH</code> should be omitted if <code>NCORE_VERSION_PATCH</code> is 0, and the <code>-</code> segment is omitted if <code>NCORE_VERSION_TAG</code> is the empty string. For example:<br/>Ncore 3.6.0-RC2 (<code>MAJOR</code>=6, <code>MINOR</code> =0, <code>PATCH</code> =0, <code>TAG</code> =RC2)<br/>Ncore 3.6.1.p3 (<code>MAJOR</code>=6, <code>MINOR</code> =1, <code>PATCH</code> =3, <code>TAG</code> =””)<br/>Ncore 3.6.2  (<code>MAJOR</code>=6, <code>MINOR</code> =2, <code>PATCH</code> =0, <code>TAG</code> =””)</p></li></ul><p><strong>In m-ncore.git</strong>: Update package.json</p><p>For the following dependencies:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">git@gitlab.arteris.com:maestro-dev/packages/utils.git
git@gitlab.arteris.com:maestro-dev/services/m-phys.git
git@gitlab.arteris.com:hardware/hw-ccp.git
git@gitlab.arteris.com:hardware/hw-lib.git
git@gitlab.arteris.com:hardware/hw-ncr.git
git@gitlab.arteris.com:hardware/hw-sym.git</pre>
</div></div><p>change the branch name to the release branch name, e.g., branch <code>#Ncore3.4/develop</code> becomes <code>#Ncore3.4/release/Ncore_3.4.6</code></p></td></tr><tr><td class="numberingColumn confluenceTd">11</td><td class="confluenceTd"><p>Create release branches in all the Git repositories in Maestro’s dependency list</p></td><td class="confluenceTd"><p>Use the <a class="external-link" href="http://jenkins-maestro1.arteris.com:8080/job/customer-releases/job/Customer-Release-Prep/" rel="nofollow">Customer Release Prep Jenkins pipeline</a>. All release branches will be the same name in every Git repo. The following data needs to be provided to this job</p><ul><li><p>RELEASE_BRANCH_NAME (see Identify Maestro Git branch name, above)</p></li><li><p>PATH_TO_MANIFEST (see Identify release content, above)</p></li><li><p>REPO_URLS (the URLs of the dependent Git repositories; these are found in the product manifest file)</p></li></ul></td></tr><tr><td class="numberingColumn confluenceTd">12</td><td class="confluenceTd"><p>Create the customer build and artifacts including tar archive and release notes; deploy the artifacts to the customer release directory</p></td><td class="confluenceTd"><p>Use the <a class="external-link" href="http://jenkins-maestro1.arteris.com:8080/job/customer-releases/job/Customer-Release-Build-MB/" rel="nofollow">Customer Release Build Jenkins pipeline</a>. The following data needs to be provided to this job:</p><ul><li><p>CHECKOUT_BRANCH_NAME (same as release branch name)</p></li><li><p>DEPLOY_BRANCH_NAME (the product architecture/major version; e.g. Ncore3.4)</p></li><li><p>DEPLOY_ROOT (the root directory for deployment of this product build; see default value for example)</p></li><li><p>CUSTOMER_RLS_DIR (directory in which customer release artifacts are copied at the end of this step; see default value)</p></li><li><p>CLIENT_RLS_DIR, SERVER_RLS_DIR, PROD_RLS_DIR (see default values)</p></li><li><p>VERSION_FILE_NAME (named of the CMakeVersion file from which version strings are pulled; see default value)</p></li><li><p>MASTER_BRANCH_NAME (name of master branch associated with the release branch; e.g., Ncore3.4/master)</p></li><li><p>Test check boxes, use defaults</p></li></ul></td></tr><tr><td class="numberingColumn confluenceTd">13</td><td class="confluenceTd"><p>Notify community about availability of the new release</p></td><td class="confluenceTd"><p>When the above build has completed successfully, add a comment in the release Jira as to the location of the released product customer deployment directories.</p></td></tr><tr><td class="numberingColumn confluenceTd">14</td><td colspan="2" class="confluenceTd"><h3 id="NcoreCustomerReleaseProcedure-AfterReleaseisFullyValidated">After Release is Fully Validated</h3></td></tr><tr><td class="numberingColumn confluenceTd">15</td><td class="confluenceTd"><p>Merge to master</p></td><td class="confluenceTd"><p>Merge release branch to master branch using these steps:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># in case master_branch is not our current branch
git checkout master_branch

# make merge commit but without conflicts!!
# the contents of &#39;ours&#39; will be discarded later
git merge -s ours release_branch

# make temporary branch to merged commit
git branch temp_branch         

# get contents of working tree and index to the one of branchB
git reset --hard release_branch

# reset to our merged commit but 
# keep contents of working tree and index
git reset --soft temp_branch

# change the contents of the merged commit
# with the contents of branchB
git commit --amend

# tag master branch commit (ex. Ncore_3.4.0)
git tag Ncore_3.4.0

# push to remote
git push origin master_branch --tags

# get rid off our temporary branch
git branch -D temp_branch</pre>
</div></div><div class="panel" style="background-color: #EAE6FF;border-color: #998DD9;border-width: 1px;"><div class="panelContent" style="background-color: #EAE6FF;">
<p>The above is borrowed from this <a class="external-link" href="https://stackoverflow.com/questions/173919/is-there-a-theirs-version-of-git-merge-s-ours" rel="nofollow">web page</a>. It will eventually be automated in Jenkins</p>
</div></div></td></tr><tr><td class="numberingColumn confluenceTd">16</td><td class="confluenceTd"><p>Merge to develop</p></td><td class="confluenceTd"><p>If any changes were made on the release branch during release testing, the responsible developer will cherry-pick these changes to the corresponding develop branch.</p></td></tr><tr><td class="numberingColumn confluenceTd">17</td><td class="confluenceTd"><p>Publish manifest</p></td><td class="confluenceTd"><p>Copy the encrypted manifest file from /engr/prerelease/maestro/release_product_directory, e.g, <code>cp /engr/prerelease/maestro/Ncore_3.4.0-10105/manifest.json manifest.json</code></p><p>Then, decrypt it</p><p><code>&lt;maestro-server&gt;</code> = path to the Maestro server just released, e.g., /engr/prerelease/maestro/Ncore_3.4.0-10105/maestro-server/maestro-server</p><p><code>&lt;local-manifest-file&gt;</code> = name of encrypted manifest file copied, e.g., manifest.json</p><p>Run:</p><p><code>&lt;maestro-server&gt; --decrypt &lt;local-manifest-file&gt; --passphrase @arter1s</code></p><p>then publish the decrypted file to <a class="external-link" href="https://arterisip.atlassian.net/l/cp/na0nYBAu" rel="nofollow">this Confluence page</a></p></td></tr><tr><td class="numberingColumn confluenceTd">18</td><td class="confluenceTd"><p>Update version on development branch as well</p></td><td class="confluenceTd"><p>Maestro will refuse to open files with a version higher than its own. Since we now concatenate <em>the version of Maestro</em> with a schema version number, if we want the development branch version of Maestro to open the files generated by any release, we need to increase its version to always be the same or higher than anything we have released. (The comparison logic looks at <code>MAJOR</code>, <code>MINOR</code> and <code>PATCH</code>, but not at any <code>TAG</code>). For example, after releasing 3.6.0.p1, we need to edit CMakeVersion.txt on the development branch Ncore3.6/develop to have <code>MAJOR</code> &gt;= 6, <code>MINOR</code> &gt;= 0, <code>PATCH</code> &gt;=1.</p></td></tr><tr><td class="numberingColumn confluenceTd">19</td><td class="confluenceTd"><p>Create module</p></td><td class="confluenceTd"><p>Create a module named ncore/n.n.n(.pn) in <a class="external-link" href="mailto:git@gitlab.arteris.com" rel="nofollow">git@gitlab.arteris.com</a>:Environment/modules.git using an existing module file as a template and changing BUILD_DIR and MAESTRO_EXAMPLES paths.</p></td></tr><tr><td class="numberingColumn confluenceTd">20</td><td class="confluenceTd"><p>Close the release Jira</p></td><td class="confluenceTd"><p>Change status to closed</p></td></tr></tbody></table></div>