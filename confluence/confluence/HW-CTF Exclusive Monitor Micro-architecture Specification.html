<h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-History">History</h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Version</th><th class="confluenceTh">Date</th><th class="confluenceTh">Comments</th><th class="confluenceTh">Editor</th></tr><tr><td class="confluenceTd">0.1</td><td class="confluenceTd">4/19/2019</td><td class="confluenceTd">Initial copy from ATUt uArch word document.</td><td class="confluenceTd">Jason Villanueva</td></tr><tr><td colspan="1" class="confluenceTd"> 0.2</td><td colspan="1" class="confluenceTd">06/29/2020 </td><td colspan="1" class="confluenceTd">Updates to match current implementation. </td><td colspan="1" class="confluenceTd">Bob Podnar </td></tr><tr><td colspan="1" class="confluenceTd"> 0.25</td><td colspan="1" class="confluenceTd">07/20/2020 </td><td colspan="1" class="confluenceTd">Added register &amp; interrupt information.</td><td colspan="1" class="confluenceTd">Bob Podnar </td></tr><tr><td colspan="1" class="confluenceTd"> 0.26</td><td colspan="1" class="confluenceTd">07/30/2020 </td><td colspan="1" class="confluenceTd">Added collisions for exclusive reads against writes pending at the target. </td><td colspan="1" class="confluenceTd">Bob Podnar </td></tr><tr><td colspan="1" class="confluenceTd"> 0.27</td><td colspan="1" class="confluenceTd">08/28/2020 </td><td colspan="1" class="confluenceTd">Simplified collision rules </td><td colspan="1" class="confluenceTd">Bob Podnar </td></tr><tr><td colspan="1" class="confluenceTd">0.28</td><td colspan="1" class="confluenceTd">09/23/2020</td><td colspan="1" class="confluenceTd">Added new information regarding address range check</td><td colspan="1" class="confluenceTd">Bob Podnar</td></tr><tr><td colspan="1" class="confluenceTd">0.29</td><td colspan="1" class="confluenceTd">12/15/2020</td><td colspan="1" class="confluenceTd">Updated the parameter list</td><td colspan="1" class="confluenceTd">Bob Podnar</td></tr><tr><td colspan="1" class="confluenceTd">0.30</td><td colspan="1" class="confluenceTd">01/26/2021</td><td colspan="1" class="confluenceTd">Add timeout details.</td><td colspan="1" class="confluenceTd">Bob Podnar</td></tr></tbody></table></div><p><br/></p><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Outline">Outline</h1><p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1759723717379 {padding: 0px;}
div.rbtoc1759723717379 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1759723717379 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1759723717379'>
<ul class='toc-indentation'>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-History'>History</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Outline'>Outline</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Features'>Features</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Interfaces'>Interfaces</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-ReferenceSpecification'>Reference Specification</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Parameters'>Parameters</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Registers'>Registers</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Description'>Description</a>
<ul class='toc-indentation'>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-CollisionScenarios'>Collision Scenarios</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Addresscollisioncalculations'>Address collision calculations</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Errorhandling'>Error handling</a></li>
<li><a href='#HW-CTFExclusiveMonitorMicro-architectureSpecification-Interrupts'>Interrupts</a></li>
</ul>
</li>
</ul>
</div></p><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Features">Features</h1><ul><li>Captures context information upon reception of an exclusive read.</li><li>Clears context information upon reception of an exclusive write with matching ID/address. </li><li>Ensures a response status of EXOKAY is returned for a successful exclusive write access being monitored. </li><li>Clobbers exclusive write request upon failed exclusive look-up and returns response with status OKAY.</li></ul><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Interfaces">Interfaces</h1><p><a href="https://arterisip.atlassian.net/wiki/spaces/ENGR/pages/16156992/HW-CTF+InterfaceCTL" data-linked-resource-id="16156992" data-linked-resource-version="1" data-linked-resource-type="page">HW-CTF InterfaceCTL</a></p><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-ReferenceSpecification">Reference Specification</h1><p><a class="external-link" href="https://confluence.arteris.com/display/ENGR/Symphony+R1+Architecture" rel="nofollow">Symphony R1 Architecture - Engineering - Confluence (arteris.com)</a></p><p><a class="external-link" href="https://confluence.arteris.com/pages/viewpage.action?pageId=10388079" rel="nofollow">Arm AMBA, CPU, DSU, &amp; Interconnect Specifications - Engineering - Confluence (arteris.com)</a></p><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Parameters">Parameters</h1><p>{</p><p>   <strong>// General </strong></p><p>    &quot;nodeId&quot; : 0 to inf, // integer</p><p>    &quot;assertOn&quot; : &quot;true&quot; or &quot;false&quot;, // boolean</p><p>    &quot;maxOutRd&quot; :  0 to 512, // integer, Max amount of outstanding reads</p><p>    &quot;maxOutWr&quot; : 0 to  512, // integer, Max amount of outstanding writes</p><p>    &quot;maxOutTotal&quot; : 0 to  512 , // integer, Max amount of outstanding transactions</p><p>    &quot;nExclEntries&quot;: 1 to inf, // Number of monitor entries to hold/track</p><p><strong> // Timing</strong><strong>  </strong></p><p>     &quot;exclPipeCtxt&quot;: &lt;0,1,...&gt; ,  // Number of Pipe Levels on Specific Path. </p><p>     &quot;exclPipeReq&quot;: &lt;0,1,...&gt; ,  // Number of Pipe Levels on Specific Path. </p><p>     &quot;exclPipeReqDP&quot;: &lt;0,1,...&gt; ,  // Number of Pipe Levels on Specific Path. </p><p>     &quot;exclPipeResp&quot;: &lt;0,1,...&gt; ,  // Number of Pipe Levels on Specific Path. </p><p>     &quot;exclPipeRespDP&quot;: &lt;0,1,...&gt; ,  // Number of Pipe Levels on Specific Path. </p><p>     &quot;exclPipeReqFwd&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  // set forward pipe</p><p>     &quot;exclPipeReqDPFwd&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  // set forward pipe</p><p>     &quot;exclPipeRespFwd&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  //  set forward pipe</p><p>     &quot;exclPipeRespDPFwd&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  //  set forward pipe</p><p>     &quot;exclPipeReqBck&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  //  set backward pipe</p><p>     &quot;exclPipeReqDBck&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  // set backward pipe</p><p>     &quot;exclPipeRespBck&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  //  set backward pipe</p><p>     &quot;exclPipeRespDPBck&quot;: &lt;&quot;no&quot;,&quot;yes&quot;&gt; ,  // set backward pipe</p><p><strong> // Interface Parameters</strong></p><p>    &quot;interfaces&quot; :{</p><p>           &quot;clkInterface&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : {}, &quot;direction&quot; : &quot;slave&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCLK" rel="nofollow" style="text-decoration: none;">InterfaceCLK</a>&quot;},</p><p>           &quot;inCtlReqInt&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : { &quot;file_path&quot; : &lt;CTL Interface Def File&gt;}, &quot;direction&quot; : &quot;master&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCTL" rel="nofollow" style="text-decoration: none;">InterfaceCTL</a>&quot;},</p><p>           &quot;inCtlRespInt&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : { &quot;file_path&quot; : &lt;CTL Interface Def File&gt;}, &quot;direction&quot; : &quot;master&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCTL" rel="nofollow" style="text-decoration: none;">InterfaceCTL</a>&quot;},</p><p>           &quot;outCtlReqInt&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : { &quot;file_path&quot; : &lt;CTL Interface Def File&gt;}, &quot;direction&quot; : &quot;master&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCTL" rel="nofollow" style="text-decoration: none;">InterfaceCTL</a>&quot;},</p><p>           &quot;outCtlRespInt&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : { &quot;file_path&quot; : &lt;CTL Interface Def File&gt;}, &quot;direction&quot; : &quot;master&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCTL" rel="nofollow" style="text-decoration: none;">InterfaceCTL</a>&quot;},</p><p>           &quot;apbInterface&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : {}, &quot;direction&quot; : &quot;slave&quot;,  &quot;interface&quot; : &quot; <a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceAPB" rel="nofollow" style="text-decoration: none;">InterfaceAPB</a>&quot;, ... TODO},</p><p>           &quot;intInterface&quot; :{ &quot;name&quot; : &quot;a_string&quot;,  &quot;params&quot; : {width : 7}, &quot;direction&quot; : &quot;master&quot;,  &quot;interface&quot; : &quot;<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceINT" rel="nofollow" style="text-decoration: none;">InterfaceINT</a>&quot;}, // Interrupt interface driven with CTL Layer interrupt</p><p>    },</p><p><strong> // Protection, Error,  and Power Control Parameters </strong></p><p>    &quot;timeoutErrChk&quot; : 0 or 1, // integer, enable timeout check</p><p>    &quot;timeoutErrCount&quot; : 0 to inf, // if 0 it is configured from registers</p><p>    &quot;timeoutUseExternalValue&quot; : 0 or 1, // 0 use timeoutErrCount, 1 use a configurable value</p><p>    &quot;timeoutErrorWidth&quot; : 32, // if 0 it is configured from registers</p><p>    &quot;registerProtectionStyle&quot; : &quot;&quot; or <a class="external-link" href="https://confluence.arteris.com/display/ENGR/protectionStyle" rel="nofollow" style="text-decoration: none;">protectionStyle</a></p><p>    &quot;csr&quot; : &quot;&quot; or Register Definition Object</p><p>}</p><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Registers">Registers</h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col style="width: 75.0px;"/><col style="width: 103.0px;"/><col style="width: 95.0px;"/><col style="width: 81.0px;"/><col style="width: 64.0px;"/><col style="width: 96.0px;"/><col style="width: 97.0px;"/><col style="width: 78.0px;"/><col style="width: 167.0px;"/></colgroup><tbody><tr><th class="confluenceTh">Register</th><th class="confluenceTh"><p>Address</p><p>(Temporary)</p></th><th class="confluenceTh">Field Name</th><th class="confluenceTh">Field Bits</th><th class="confluenceTh">Access</th><th class="confluenceTh">Reset Value</th><th class="confluenceTh">Description</th><th class="confluenceTh">Optional</th><th class="confluenceTh">Controlling Parameter</th></tr><tr><td class="confluenceTd"><strong>Error registers</strong></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">EXCLTIR</td><td class="confluenceTd">0x0</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd">I</td><td class="confluenceTd">0</td><td class="confluenceTd">w1c</td><td class="confluenceTd">0</td><td class="confluenceTd">Timeout interrupt</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd">E</td><td class="confluenceTd">0</td><td class="confluenceTd">rw</td><td class="confluenceTd">0</td><td class="confluenceTd">Timeout interrupt enable</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd">SID</td><td class="confluenceTd">15+SID_WIDTH:15</td><td class="confluenceTd">rw</td><td class="confluenceTd">0</td><td class="confluenceTd">Timeout src Id</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><strong>Timeout config register</strong></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">EXCLTCR</td><td class="confluenceTd">0x300</td><td class="confluenceTd">COUNT</td><td class="confluenceTd">0:31</td><td class="confluenceTd">rw</td><td class="confluenceTd">0</td><td class="confluenceTd">Timeout Count (Clock cycles) (0==disabled)</td><td class="confluenceTd">x</td><td class="confluenceTd">timeoutUseExternalValue</td></tr></tbody></table></div><h1 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Description">Description</h1><p>This is the micro-architecture specification for the Exclusive Monitor. The block will act as a bi-directional adapter.</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="https://confluence.arteris.com/plugins/servlet/confluence/placeholder/unknown-attachment?locale=en_US&amp;version=2" data-image-src="https://confluence.arteris.com/plugins/servlet/confluence/placeholder/unknown-attachment?locale=en_US&amp;version=2" loading="lazy"></span></p><p><strong>AXI specification</strong></p><p>The AXI exclusive access mechanism can provide semaphore-type operations without requiring the bus to remain dedicated to a particular master for the duration of the operation. This means the semaphore-type operations do not impact either the bus access latency or the maximum achievable bandwidth.</p><div>The AxLOCK signals select exclusive access, and the RRESP and BRESP signals indicate the success or failure of the exclusive access read or write respectively.</div><p><em>Exclusive transaction restrictions (from the AXI spec)</em>:</p><ul><li>The burst size and burst length of an exclusive write with a given ID must be the same as the burst size and burst length of the preceding exclusive read with the same ID.</li><li>The address of an exclusive access must be aligned to the total number of bytes in the transaction, that is, the product of the burst size and burst length.</li><li>The addresses for the exclusive read and the exclusive write must be identical.</li><li>The ID value of the exclusive read must match the ID value of the exclusive write.</li><li>The control signals for the exclusive read and exclusive write transactions must be identical.</li><li>The number of bytes to be transferred in an exclusive access burst must be a power of 2, that is, 1, 2, 4, 8, 16, 32, 64, or 128 bytes.</li><li>The maximum number of bytes that can be transferred in an exclusive burst is 128.</li><li>In AXI4, the burst length for an exclusive access must not exceed 16 transfers.</li><li>The value of the AxCACHE signals must guarantee that the slave that is monitoring the exclusive access sees the transaction. For example, an exclusive access must not have an AxCACHE value that indicates that the transaction is Cacheable.</li></ul><p>Failure to observe these restrictions causes UNPREDICTABLE behavior.</p><p>For this implementation:</p><ul><li>no error checking is performed for the above list</li><li>split transactions are not supported; it is the responsibility of the system designer to ensure that a system requiring exclusive transactions is configured in such a way that an exclusive will not be split. splitting will result in unpredictable behavior.</li><li>msg_len/msg_addr are stored in the monitor per entry, and are used to compare vs. the incoming transaction. An exact match must occur for a match.</li><li>axcache is ignored and passed through. it is assumed that if the transaction was visible to the exclusive monitor, then the value is correct</li></ul><p>The basic behavior of an exclusive monitor:</p><ol><li>A master performs an exclusive read from an address. The exclusive monitor stores the <strong>ID</strong> {SRC ID, REQ ID}, and address {start address, size} if:<ol><li>there is not a write pending at the target for which a write response has not been received that had an address range overlap with the exclusive read. This is to prevent the exclusive read from being re-ordered around the write at the target.</li><li>there is an unused monitor entry, or</li><li>there is a current monitor entry from the same srcId/msgId (with no outstanding wrExcl at the target) that can be replaced with the new exclusive read.</li></ol></li><li>At some later time, the master attempts to complete the exclusive operation by performing an exclusive write to the same address, and with an <strong>ID </strong>that matches the <strong>ID </strong>used for the exclusive read.</li><li>This exclusive write access is signaled as either:<ol><li>Successful, if no other master has written to that location since the exclusive read access. In this case the exclusive monitor will send the request through towards the target and updates memory. The monitor will ensure the write response returns with status EXOKAY. </li><li>Failed, if another master has written to that location since the exclusive read access, or the monitor has changed to another address. In this case the monitor will not send the write request through towards the target and the memory location is not updated (and the lock is released). The monitor will generate a response with status OKAY (instead of EXOKAY). <br/>Only 1 entry is stored for a given ID, and a new exclusive read can replace an existing exclusive read.</li></ol></li><li>When the number of exclusive monitor entries in use are full, any new exclusive read is passed through without storing it in the monitor context. The response returning will return with an OKAY response.  </li></ol><p><strong><em>Context Control</em></strong></p><p>The context block is responsible for the allocation, de-allocation and modification of the exclusive monitor. One context entry is equivalent to one monitor entry.</p><p>A context entry is allocated if an exclusive read transaction is received that meets the qualifications. The entry will stay valid in the 'exclusive' state until any master attempts to write to the address being monitored in the entry. </p><p>No data is stored in context. Write data or read response data is is stalled in the pipes using the rdy signal.</p><p>An exclusive write that matches a context entry will  a non-exclusive status, then the request will be not be sent through &amp; a response will immediately be returned with status OKAY.</p><p>The context entry will only be cleared when either the a matching write from the same src/Id is received, or a timeout has occurred. </p><p><strong><em>Write Data Path</em></strong></p><p>Write data that arrives at the exclusive monitor earlier than the request will stall and wait for the request to arrive. Since the request has not yet arrives, it is not known whether the data is for an exclusive write.</p><p>Exclusive writes that fail will be sent to the target with write strobes set equal to zero. It is the responsibility of the target to not perform the write. For the apb target native layer that does not have write strobes, it is the responsibility of the native later to drop the write.</p><p>Sending the write to the target helps maintain response ordering and removed the need to inject a manufactured response into the write response channel.</p><p><strong><em>Response Path</em></strong></p><p>The response block is responsible for or'ing in the exokay value into either the read response or write response channel.</p><p><strong><em>Exclusive  Context Storage</em></strong></p><p>The number of entries is defines by parameter nExclEntries.</p><p>The following table summarizes the data fields stored per entry. (per entry, number of entries – parameterized by nExclEntries)</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/></colgroup><thead><tr><th class="confluenceTh"><div class="tablesorter-header-inner">Entry</div></th><th class="confluenceTh"><div class="tablesorter-header-inner">Width</div></th><th class="confluenceTh"><div class="tablesorter-header-inner">Description</div></th></tr></thead><tbody><tr><td class="confluenceTd">ID</td><td class="confluenceTd">{SRC ID, REQ ID}</td><td class="confluenceTd"><p>Transaction ID uniquified per source</p></td></tr><tr><td class="confluenceTd">Address</td><td class="confluenceTd">{start address, size}</td><td class="confluenceTd"><p>Start address - aligned to transfer size (burst size x burst length), size is power of 2 bytes, limited to 128B and burst length limited to 16.</p></td></tr><tr><td class="confluenceTd">exclusive</td><td class="confluenceTd">1</td><td class="confluenceTd"><p>Set on exclusive read access, cleared if there is a write from a different master matches the address.</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>outstanding</p><p>transaction</p></td><td colspan="1" class="confluenceTd">1 </td><td colspan="1" class="confluenceTd">A write is pending at the target that will make modifications to this entry </td></tr><tr><td class="confluenceTd">valid</td><td class="confluenceTd">1</td><td class="confluenceTd">Set on exclusive read access to occupy an exclusive monitor entry. Cleared on corresponding exclusive write access or timeout.</td></tr><tr><td colspan="1" class="confluenceTd"> timeout</td><td colspan="1" class="confluenceTd">1 </td><td colspan="1" class="confluenceTd">Set upon the first rollover of the optional internal timer. Clear at creation. </td></tr></tbody></table></div><p><strong><em> State machine</em></strong></p><p>The state machine is taken from the <a class="external-link" href="https://confluence.arteris.com/display/ENGR/Symphony+Architecture+Spec" rel="nofollow">Symphony Spec, Rev. 0.95</a>, Figure 6-19, Section &quot;Monitor State Machine and Monitor Table&quot;.</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" src="https://confluence.arteris.com/plugins/servlet/confluence/placeholder/unknown-attachment?locale=en_US&amp;version=2" data-image-src="https://confluence.arteris.com/plugins/servlet/confluence/placeholder/unknown-attachment?locale=en_US&amp;version=2" loading="lazy"></span></p><p style="margin-left: 30.0px;"><strong>Definitions (from Symphony spec)</strong>:</p><p style="margin-left: 30.0px;"><strong>x</strong>: \{memory address, range\}</p><p style="margin-left: 30.0px;"><strong>n</strong>: \{srcId,ID\}</p><p style="margin-left: 30.0px;"><em>ID</em>: \{axiId,UserBits}</p><p style="margin-left: 30.0px;"><strong>t</strong>: tagged Address (address exists in the monitor table; For ex, '!t' would mean that the address is not being monitored)</p><p>Note: Although writeExcl(!t,n) is in two places in the above diagram as being architecturally allowable, the symphony implementation fails the write and returns to the 'off' state.</p><p>While in the On state, the monitor entry can have either the Exclusive, or OutstandingTransaction attribute set. These 2 are mutually exclusive. Exclusive state must be set for a matching exclusive write to succeed. OutstandingTransaction (also referred to as the 'ng' state) is set when an exclusive write has found the monitor entry to be exclusive, has been sent to the target, but the write response has not yet been received.</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Type</th><th class="confluenceTh">Full</th><th class="confluenceTh"><div class="content-wrapper"><p>Match</p><p>(ADDR,SIZE)</p></div></th><th class="confluenceTh"><p>Match</p><p>(TagId,SrcId)</p></th><th class="confluenceTh">NG</th><th class="confluenceTh">EXCL</th><th class="confluenceTh">RESP</th><th class="confluenceTh">Notes</th></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">-</td><td class="confluenceTd">-</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">Create new entry; set exclusive</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">-</td><td class="confluenceTd">-</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">No action</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">Write new address to existing entry; set exclusive</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">Write new address to existing entry</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">No action</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">x</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">Write new address to existing entry; set exclusive</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">No action</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">Set exclusive</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">No action</td></tr><tr><td class="confluenceTd">rdEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">No action</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">-</td><td class="confluenceTd">-</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">-</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0; Clear matching entry (as per Symph spec)</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">-</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">x</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0; clear matching entry</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">0</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set writes strobes=0; clear matching entry</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">1</td><td class="confluenceTd">EXOKAY</td><td class="confluenceTd">clear matching entry</td></tr><tr><td class="confluenceTd">wrEx</td><td class="confluenceTd">x</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">1</td><td class="confluenceTd">0</td><td class="confluenceTd">OKAY</td><td class="confluenceTd">Set write strobes=0</td></tr><tr><td colspan="1" class="confluenceTd"> write</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> 1</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> 0</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> OKAY</td><td colspan="1" class="confluenceTd">clear matching  entry</td></tr><tr><td colspan="1" class="confluenceTd"> write</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> 1</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> 1</td><td colspan="1" class="confluenceTd"> x</td><td colspan="1" class="confluenceTd"> OKAY</td><td colspan="1" class="confluenceTd"> No action</td></tr></tbody></table></div><p><em>Full:</em></p><p>When the Exclusive monitor table is full, any new exclusive read request will receive an okay response. There is no eviction policy in effect for this implementation. It is the responsibility of the system designer to create enough monitor table entries that a typical system would require, most likely one per exclusive master.</p><h2 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-CollisionScenarios">Collision Scenarios</h2><p>There are two simplified collision scenarios:</p><ol><li> Any incoming exclusive read will not establish a monitor entry if there is a write pending at the target that:<ol><li>has an overlapping address range with the read, and</li><li>the write is of any write type, nonexclusive or exclusive (pass or fail)</li></ol></li><li>Any incoming non-exclusive write will stall if there is a write pending at the target that:<ol><li>has an overlapping address range with the incoming write, and</li><li>the write at the target is an exclusive write (pass or fail)</li></ol></li></ol><p>The following is a table of collision types and the required actions:</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/></colgroup><tbody><tr><th colspan="1" class="confluenceTh"><br/></th><th class="confluenceTh"><p>Operation at Monitor</p></th><th class="confluenceTh">Operation at Target</th><th class="confluenceTh">Collision Action</th><th class="confluenceTh">Notes</th></tr><tr><td colspan="1" class="confluenceTd">1 </td><td class="confluenceTd">non-exclusive write</td><td class="confluenceTd">exclusive write - failed</td><td class="confluenceTd">stall write</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"> 2</td><td class="confluenceTd">non-exclusive write</td><td class="confluenceTd">exclusive write - passed</td><td class="confluenceTd">stall write</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"> 3</td><td class="confluenceTd">exclusive write</td><td class="confluenceTd">exclusive write - failed</td><td class="confluenceTd">none</td><td class="confluenceTd">the exclusive write at the monitor is guaranteed to fail because any prior read will not have established a successful monitor entry</td></tr><tr><td colspan="1" class="confluenceTd"> 4</td><td class="confluenceTd">exclusive write</td><td class="confluenceTd">exclusive write - passed</td><td class="confluenceTd">none</td><td class="confluenceTd">the exclusive write at the monitor is guaranteed to fail because any prior read will not have established a successful monitor entry</td></tr><tr><td colspan="1" class="confluenceTd"> 5</td><td class="confluenceTd">exclusive read</td><td class="confluenceTd">exclusive write - failed</td><td class="confluenceTd">return okay and does not establish monitor entry</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"> 6</td><td class="confluenceTd">exclusive read</td><td class="confluenceTd">exclusive write - passed</td><td class="confluenceTd">return okay and does not establish monitor entry</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"> 7</td><td class="confluenceTd">exclusive read</td><td class="confluenceTd">non-exclusive write</td><td class="confluenceTd">return okay and does not establish monitor entry</td><td class="confluenceTd"><br/></td></tr></tbody></table></div><h2 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Addresscollisioncalculations"><strong><em>Address collision calculations</em></strong></h2><p>For timing purposes, instead of performing an exact address range compare, an approximate address range compare is performed:</p><ol><li>shift multiple input request length by 2</li><li>fill all bits to the right of the uppermost 1 with 1's (ex: 0110_1101 → 0111_1111)</li><li>perform the same fill for the monitor address length</li><li>'or' the two newly created masks together</li><li>invert</li><li>'and'  the mask with both the input request address and the monitor address</li><li>compare addresses</li></ol><p>No addition or subtraction is required for this process. An additional step could be added to the input request address that checks for a size-aligned request, in which case a multiply-by-two step is not required (the x2 is not required for the aligned monitor entries).</p><p>Ex:</p><p style="margin-left: 30.0px;">req_addr: 0x0a12, length=0x6d</p><p style="margin-left: 30.0px;">req_addr_mask: 0xff00</p><p style="margin-left: 30.0px;">monitor_addr: 0x0aaa, length=0x1</p><p style="margin-left: 30.0px;">monitor_addr_mask: 0xfffe</p><p style="margin-left: 30.0px;">combined mask: 0xff00</p><p style="margin-left: 30.0px;">addresses to compare: (0x0a00 == 0xa00) // it's a match</p><p>Note that this same address match flow is also used for the write request addresses in the pending write request queue.</p><h2 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Errorhandling"><strong><em>Error handling</em></strong></h2><p>A single timeout counter has been implemented such that a monitor entry that has had no updates for 2 rollovers of the timeout counter will be cleared. Error handling is not the default, and needs to be enabled using <strong><em>timeoutErrChk</em></strong>=1. The timeout counter size can be set one of two ways:</p><ol><li><strong><em>timeoutUseExternalValue</em></strong>=0: counter value is the build parameter <strong><em>timeoutErrCount</em></strong></li><li><strong><em>timeoutUseExternalValue</em></strong>=1: counter value is the value of the <strong><em>EXCLTCR</em></strong> register.</li></ol><p>The timeout counter is set/cleared according to the following rules:</p><ol><li>A monitor entry is created with timeout cleared.</li><li>The timeout bit can be set the cycle after the single free-running timeout counter rolls over (called timeout tick).</li><li>The timeout bit will not be set if on the cycle of the timeout tick &amp; there is an exclusive read in the pipeline of the same Id (srcId/msgId).</li><li>The timeout bit will not be set if on the cycle of the timeout tick &amp; there is an exclusive write with matching address.</li><li>The timeout bit will not be set if the exclusive write is pending at the target.</li><li>The timeout bit is cleared when either 1) the monitor entry is replaced by a new exclusive read from the same Id, 2) the matching exclusive write has been received, or 3) timeout has been detected and the entry invalidated due to timeout.</li></ol><h2 id="HW-CTFExclusiveMonitorMicro-architectureSpecification-Interrupts"><strong><em>Interrupts</em></strong></h2><p>If and interrupt interface is present, and the timeout error checking is enabled, then an interrupt will be generated when a timeout error has occurred.</p><p><br/></p><p><br/></p>