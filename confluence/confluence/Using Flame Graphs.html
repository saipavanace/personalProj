<h2 id="UsingFlameGraphs-Tool#1:perf"><strong>Tool #1: perf</strong></h2><p><br/></p><p>To profile Maestro, one of the most convenient option is &quot;perf&quot;:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">sudo yum install perf</pre>
</div></div><p>From a terminal, launch Maestro. <strong>When profiling, it's always recommended to use a debug build</strong>; although it will be much slower than a release build and occasionally will spend excessive time on things that are optimized away in a release build, nevertheless, it's much easier to follow the code and see exactly what is wasting time. (Also, there is prevalent usage of debug builds of Maestro inside Arteris, so speeding up these builds is still beneficial.) Then attach perf to it:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">/some/path/bin/maestro &amp;
perf record -g -p &lt;pid&gt;</pre>
</div></div><p class="auto-cursor-target">Where &quot;-g&quot; instructs perf to save the call graph, and &quot;-p&quot; takes as an input the PID of the binary to screen.</p><p class="auto-cursor-target">perf is now monitoring the maestro executable and is periodically saving a snapshot of its call stack. The sampling frequency can be tuned with -F. A large number of other options are available, you can e.g. refer to <a class="external-link" href="https://perf.wiki.kernel.org/index.php/Tutorial" rel="nofollow">https://perf.wiki.kernel.org/index.php/Tutorial</a>.</p><p class="auto-cursor-target">Since perf saves lots of data to disk, it is useful to <strong>narrow down as much as possible the operations to be monitored</strong>. Therefore, it's a good idea to:</p><ol><li class="auto-cursor-target">Get Maestro ready at the exact spot where the profiling should begin (e.g. just before launching a time-consuming operation)</li><li class="auto-cursor-target">Start perf and attach it to Maestro</li><li class="auto-cursor-target">Immediately go back to Maestro and launch the action to be profiled</li><li class="auto-cursor-target">As soon as it is done, go back to the terminal where perf is running and hit Ctrl-C to stop data collection. </li></ol><p>This helps to collect a clean trace without spurious activity, especially when profiling Maestro in GUI mode. Also see the comments later in the page about narrowing down what is displayed in the Flame Graph.</p><p>Now that the data is collected, it's possible to inspect it:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">perf report</pre>
</div></div><p class="auto-cursor-target">This launches an interactive viewer displaying the outcome of the inspection:</p><p class="auto-cursor-target"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="250" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/image2021-11-3_14-21-1.png?api=v2"></span></p><p class="auto-cursor-target">It's possible to navigate with arrow keys/Enter to expand/collapse each line. The red percentages indicate the total execution time (according to the samples collected by perf) that was spent in each function and its callees.</p><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p class="auto-cursor-target">Note that <strong>the logged</strong><strong> data (perf.data) isn't, by itself, transferrable to another machine or intended for preservation</strong>; instead, it relies on symbols in the various binaries and libraries as they presently exist on the developer's machine. Without access to the right version of those binaries, opening perf.data will just display meaningless hex addresses. To collect all that is needed for sharing with colleagues or long-term storage, this command must be used:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">perf archive</pre>
</div></div><p class="auto-cursor-target">This command will create a large .bz2 with the performance logs as well as the Maestro executable and all referenced underlying libraries. This archive is portable.</p></div></div><p class="auto-cursor-target">To view this information as a Flame Graph, you need additional utility code:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">git clone https://github.com/brendangregg/FlameGraph.git</pre>
</div></div><p class="auto-cursor-target">This will clone the FlameGraph repo to your machine. No need to compile anything. See <a class="external-link" href="https://www.brendangregg.com/perf.html" rel="nofollow">https://www.brendangregg.com/perf.html</a> and <a class="external-link" href="https://github.com/brendangregg/FlameGraph" rel="nofollow">https://github.com/brendangregg/FlameGraph</a> for more information and examples. This is a brief example of how to use the tool:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">cd &lt;directory_where_perf_was_run&gt;
perf script &gt; out.perf
/path/to/FlameGraph/stackcollapse-perf.pl out.perf &gt; out.folded
/path/to/FlameGraph/flamegraph.pl out.folded &gt; out.svg
         # Here, instead, you can use grep to only look at some functions of interest, e.g. if you only care about the profiling of the &quot;cpuid&quot; function:
         # grep cpuid out.folded | /path/to/FlameGraph/flamegraph.pl &gt; cpuid.svg
firefox out.svg</pre>
</div></div><p class="auto-cursor-target">The resulting image, in SVG format, can be opened in many image editors, but it's best viewed inside a browser as the SVG format allows to do special things on hovering, clicking, etc.; in other words, the chart can be interactively explored. See the example below. (Confluence does not allow the SVG image to be browsed inline; see the PNG below for a &quot;static&quot; idea of the contents of the Flame Graph, but download the SVG and open it in a new tab to explore the dynamic features.)</p><p class="auto-cursor-target"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="800" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/profilingconsole.png?api=v2"></span></p><p><a href="/wiki/spaces/ENGR/pages/16165397/Using+Flame+Graphs?preview=%2F16165397%2F16175947%2Fprofilingconsole.svg"><span style="background: url('/wiki/s/-672721829/6452/d621ad2a33e27b90ca05c475b216bfab745e08a2/1000.0.0-d621ad2a33e2/_/download/resources/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-resources/images/placeholder-medium-file.png'); width: 250px; height: 95px; display: inline-block; padding-top: 155px; margin: 2px; border: 1px solid #ddd; text-align: center; vertical-align: text-bottom; text-decoration: none; font-size: 12px; color: #000;">profilingconsole.svg</span></a></p><p><br/></p><p><br/></p><h2 id="UsingFlameGraphs-Tool#2:collect+analyzer"><strong>Tool #2: collect + analyzer</strong></h2><p><br/></p><p>An alternative tool comes from Oracle Developer Studio (<a class="external-link" href="https://www.oracle.com/application-development/developerstudio/" rel="nofollow">https://www.oracle.com/application-development/developerstudio/</a>) that is called <strong><em>collect</em></strong>.</p><p>A copy of tool can be found in :</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">/home/zqin/BIN/developerstudio12.6</pre>
</div></div><p><br/></p><p>Below is an example of using collect to profile the Tcl test <em>hw_config_06</em>, which takes quite a few minutes to finish</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">252/252 Test #182: maestro/test_tcl/hw_config_06/hw_config_06.sh .......................................................................   Passed  417.78 sec</pre>
</div></div><p><br/></p><p>To gather the profiling data, simply run the test while enabling <em>collect</em>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">$ ~/BIN/developerstudio12.6/bin/collect bash ./hw_config_06.sh ../../../../tests/common/ ../../../bin/maestro</pre>
</div></div><p><br/></p><p>It requires no modification of the source code, or the binary to be profiled.</p><p>Once finished, <em>collect</em> put the gathered data in a folder called “<em><a class="external-link" href="http://test.1.er" rel="nofollow">test.1.er</a></em>” in this case, which can be visualized with <strong><em>analyzer </em></strong>that is also part of the Developer Studio:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">$ ~/BIN/developerstudio12.6/bin/analyzer test.1.er/&amp;</pre>
</div></div><p><br/></p><p>Here’s an overview of the results:</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/%231.png?api=v2"></span></p><p>Apparently, maestro is not multi-threaded (yes, it also supports multi-threading).</p><p>The “Call Tree” view gives a better idea on where the time was spent.</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/%232.png?api=v2"></span></p><p>Also helpful is the view of “Function”:</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/%233.png?api=v2"></span></p><p>It’s also possible to directly jump to the source code and even disassembly for a given function.</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/%234.png?api=v2"></span></p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="https://arterisip.atlassian.net/wiki/download/attachments/16165397/%235.png?api=v2"></span></p><p>As such, we can spot the performance bottle-neck quite easily.</p><p><br/></p>