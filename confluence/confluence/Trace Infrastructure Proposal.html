<p>Assumption: Using present TACHL compiler.</p><h1 id="TraceInfrastructureProposal-AdditionstoFlow">Additions to Flow</h1><p>Add to gen_wrapper a new parameter:</p><pre>top: boolean // true means gen_wrapper is top wrapper. Used to create trace global parameters in verilog and initialize trace filehandle.</pre><p>Add the following global parameter definitions (-I vs. -i) to be supported by SW:</p><pre>traceOn: boolean // true means trace is turned on.<br/><br/>traceStructure: { <br/>  globals: { <br/>    traceFile: string, // A hierarchical path to the trace filehandle <br/>    globalTimeStamp: string, // A hierarchical path to the globalTimeStamp counter<br/>    sampleTime: integer, // Number of global clocks between block status samples, if 1 no block status dumps.<br/>    traceOn: string, // A hierarchical path to the reg that turns trace on or off <br/>    closeTrace: string, // A hierarchical path to the reg that closes the trace file<br/>    globalClk: string // Name of clock interface in top gen_wrapper used to increment global counter. </pre><pre>  }<br/>}<br/><br/></pre><h1 id="TraceInfrastructureProposal-OutputFileStructure">Output File Structure</h1><p>Output file will be a file will be named &quot;trace_file.json&quot;, exist in the directory of where the simulation tool is run and have the following structure:</p><pre>[<br/>{&quot;start_of_trace&quot;: true, &quot;module&quot;: &quot;dut_smi.u_dut &quot;, &quot;timestamp&quot;: 0},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_3.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x040000000000e000f0000000000000000000000000000000000000000000b0000000f010f010f010f010f010f010f010f01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_2.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x040000000000d000e0000000000000000000000000000000000000000000b0000000e010e010e010e010e010e010e010e01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_1.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x1c00000000009000d0000000000000000000000000000000000000000000b0000000d010d010d010d010d010d010d010d01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_0.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x1a80000000009000c0000000000000000000000000000000000000000000b0000000c010c010c010c010c010c010c010c01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_3.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x1c00000000007000b0000000000000000000000000000000000000000000b0000000b010b010b010b010b010b010b010b01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_2.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x1c00000000006000a0000000000000000000000000000000000000000000b0000000a010a010a010a010a010a010a010a01&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_1.U_switch&quot;,&quot;port&quot;: &quot;i_4&quot;, &quot;timestamp&quot;: 3, &quot;localtime&quot;: 4, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x188000000000400090000000000000000000000000000000000000000000b00000009010901090109010901090109010901&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>.<br/>.<br/>.<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_3.U_switch&quot;,&quot;port&quot;: &quot;i_3&quot;, &quot;timestamp&quot;: 10000, &quot;localtime&quot;: 10001, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x008000001240d000300000000000000000000000000000000000000001f7300000003ee03ee03ee03ee03ee03ee03ee03ee&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_3.U_switch&quot;,&quot;port&quot;: &quot;o_0&quot;, &quot;timestamp&quot;: 10000, &quot;localtime&quot;: 10001, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x040000000000d000f000000000000000000000000000000000000000001030000000f200f200f200f200f200f200f200f20&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_3.U_switch&quot;,&quot;port&quot;: &quot;o_4&quot;, &quot;timestamp&quot;: 10000, &quot;localtime&quot;: 10001, &quot;beatcount&quot;: 1, &quot;bus&quot;: &quot;394x000001252500f00000000000000000000000000000000000000000000032300000000640064006400640064006400640064&quot;,&quot;pktDef&quot;: &quot;buf&quot;},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw0_0.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.296430, &quot;in_bp_efficiency&quot;: 0.739044, &quot;out_efficiency&quot;: 0.296370, &quot;out_bp_efficiency&quot;: 0.782264},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw0_1.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.431057, &quot;in_bp_efficiency&quot;: 0.747970, &quot;out_efficiency&quot;: 0.430997, &quot;out_bp_efficiency&quot;: 0.859776},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw0_2.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.435736, &quot;in_bp_efficiency&quot;: 0.753788, &quot;out_efficiency&quot;: 0.435676, &quot;out_bp_efficiency&quot;: 0.861209},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw0_3.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.302570, &quot;in_bp_efficiency&quot;: 0.746607, &quot;out_efficiency&quot;: 0.302490, &quot;out_bp_efficiency&quot;: 0.782757},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw1_0.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.405939, &quot;in_bp_efficiency&quot;: 0.636991, &quot;out_efficiency&quot;: 0.405899, &quot;out_bp_efficiency&quot;: 0.828246},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw1_1.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.547025, &quot;in_bp_efficiency&quot;: 0.675808, &quot;out_efficiency&quot;: 0.546925, &quot;out_bp_efficiency&quot;: 0.880437},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw1_2.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.551905, &quot;in_bp_efficiency&quot;: 0.678300, &quot;out_efficiency&quot;: 0.551785, &quot;out_bp_efficiency&quot;: 0.881534},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw1_3.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.409199, &quot;in_bp_efficiency&quot;: 0.639218, &quot;out_efficiency&quot;: 0.409119, &quot;out_bp_efficiency&quot;: 0.826820},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_0.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.404740, &quot;in_bp_efficiency&quot;: 0.635627, &quot;out_efficiency&quot;: 0.404640, &quot;out_bp_efficiency&quot;: 0.823994},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_1.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.548285, &quot;in_bp_efficiency&quot;: 0.676779, &quot;out_efficiency&quot;: 0.548165, &quot;out_bp_efficiency&quot;: 0.880845},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_2.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.553365, &quot;in_bp_efficiency&quot;: 0.684265, &quot;out_efficiency&quot;: 0.553245, &quot;out_bp_efficiency&quot;: 0.884459},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw2_3.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.408659, &quot;in_bp_efficiency&quot;: 0.639954, &quot;out_efficiency&quot;: 0.408599, &quot;out_bp_efficiency&quot;: 0.828179},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_0.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.296550, &quot;in_bp_efficiency&quot;: 0.733455, &quot;out_efficiency&quot;: 0.296510, &quot;out_bp_efficiency&quot;: 0.770554},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_1.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.429417, &quot;in_bp_efficiency&quot;: 0.741830, &quot;out_efficiency&quot;: 0.429297, &quot;out_bp_efficiency&quot;: 0.853830},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_2.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.436336, &quot;in_bp_efficiency&quot;: 0.746536, &quot;out_efficiency&quot;: 0.436216, &quot;out_bp_efficiency&quot;: 0.868732},<br/>{&quot;block_status&quot;: true, &quot;instance&quot;: &quot;dut_smi.u_dut.U_meshATP.U_sw3_3.U_switch&quot;, &quot;timestamp&quot;: 10000, &quot;in_efficiency&quot;: 0.298750, &quot;in_bp_efficiency&quot;: 0.737692, &quot;out_efficiency&quot;: 0.298670, &quot;out_bp_efficiency&quot;: 0.776570},<br/>{&quot;end_of_trace&quot;: true}<br/>]<br/><br/></pre><p>start_trace: true</p><p style="margin-left: 30.0px;">Trace started. Mainly used to start JSON file syntax.</p><p>block_status: true</p><p style="margin-left: 30.0px;">Used for a block to print out accumulated status over the sampleTime of trace. These are just example fields:</p><p style="margin-left: 60.0px;">instance: Hierarchical path to block (except for top block which is name of module)</p><p style="margin-left: 60.0px;">timestamp: global timestamp when status taken</p><p style="margin-left: 60.0px;">in_efficiency: For all block input ports (#(ready &amp;&amp; valid)/number of local clocks in trace)</p><p style="margin-left: 60.0px;">in_bp_efficiency: For all block input ports (#(read &amp;&amp; valid)/#valid)</p><p style="margin-left: 60.0px;">out_efficiency: For all block output ports (#(ready &amp;&amp; valid)/number of local clocks in trace)</p><p style="margin-left: 60.0px;">out_bp_efficiency: For all block output ports (#(read &amp;&amp; valid)/#valid)</p><p>end_of_trace: true</p><p style="margin-left: 30.0px;">Trace has ended. Mainly used to close JSON file syntax.</p><p>All others</p><p style="margin-left: 30.0px;">Trace data</p><p style="margin-left: 60.0px;">instance: Hierarchical path to block (except for top block which is name of module)</p><p style="margin-left: 60.0px;">port: The port on the block the trace data is from.</p><p style="margin-left: 60.0px;">timestamp: The timestamp of the trace at start of transaction.</p><p style="margin-left: 60.0px;">localtime: The local time at the end of the transaction. May not have same clock ratio as timestamp.</p><p style="margin-left: 60.0px;">beatcount: Number of beats in transaction.</p><p style="margin-left: 60.0px;">bus: The contents of the first beat of the transaction. Form is &quot;bitWidth&quot;x&quot;HexValue&quot;</p><p style="margin-left: 60.0px;">pktDef: Name of the link packet definition used to create bus. Definition is usually in &quot;lib&quot; directory where generated verilog is output.</p><p>The purpose of this structure is to create a standard structure that can then be converted to any desired trace tool with a simple script. The file structure is inherently JSON, so it's structured and that structure can be copied and used to create trace formatting file and then convert the trace output to the form desired by the tool.</p><h1 id="TraceInfrastructureProposal-Modificationstoexistingcode">Modifications to existing code</h1><h2 id="TraceInfrastructureProposal-gen_wrapper">gen_wrapper</h2><p>When traceOn == true, the gen_wrapper will add a parameter </p><p style="margin-left: 30.0px;">instanceName: string</p><p>to all blocks and if top == true, will instance the following registers:</p><p style="margin-left: 30.0px;">integer global_counter;</p><p style="margin-left: 30.0px;">integer trace_file;</p><p style="margin-left: 30.0px;">reg traceOn;</p><p style="margin-left: 30.0px;">reg closeTrace;</p><p>And add in code to initialize trace_file as a filehandle and write in the header object to the file and it use interface specified in globalClk and use it to reset and increment global_counter.</p><p>Register traceOn will default to 1'b1 which indicates trace is enabled.</p><p>Register closeTrace will default to 1'b0 and when becomes 1'b1, will close trace files and end simulation on the next rising edge of globalClk. </p><h2 id="TraceInfrastructureProposal-OtherBlocks">Other Blocks</h2><p>Other blocks where it is desired to add in an ability the trace their interfaces, such as sym_switch, will add traceOn as a parameter defaulting to false. If traceOn is true, then the block will grab the values of parameters instanceName and traceStructure and instance a block that been written to trace a particular interface type, such as InterfaceATP. The TACHL style for the trace block will be old interfaces, because the block needs to not drive outputs and old interfaces allows you to exclude pins from an interface.</p><h1 id="TraceInfrastructureProposal-ConverterScripts">Converter Scripts</h1><p>Because there are multiple trace tools out there that have different file formats, converter scripts will need to be written that read in the trace file output and convert the desired tool file structure.</p><h1 id="TraceInfrastructureProposal-HowtorunwhentheversionofMaestrodoesn&#39;tsupportthenewtracefeatures">How to run when the version of Maestro doesn't support the new trace features</h1><p>1) Run the test you want to trace and create a dump file.</p><p>2) Bring up the wave in a viewer and determine the path name to the top gen_wrapper. In this example we're going to assume that it's:</p><p style="margin-left: 30.0px;">tb_top.m_top_wrapper</p><p>3) CD into hw-sym and hw-lib and do a &quot;git checkout master&quot; for both.</p><p>4) Modify hw-sym/js/lib_utils and modify the following three functions from:</p><pre>function getTraceStructDefault () {<br/><br/>  var example_default = {<br/>    globals: {<br/>      traceFile: 'tb_top.m_top_wrapper.trace_file',<br/>      globalTimeStamp: 'tb_top.m_top_wrapper.global_counter', <br/>      sampleTime: 1,<br/>      traceOn: 'tb_top.m_top_wrapper.traceOn',<br/>      closeTrace: 'tb_top.m_top_wrapper.closeTrace',<br/>      globalClk: 'tb_top.m_top_wrapper.mainRegime_Cm_root_'<br/>    }<br/>  }<br/><br/>  return null;<br/>}<br/><br/>function getTraceOnDefault () {<br/>  return false;<br/>}<br/><br/>function getDumpTraceDefault () {<br/>  return &quot;1'b1&quot;;<br/>}</pre><p>to: </p><pre>function getTraceStructDefault () {<br/><br/>  var example_default = {<br/>    globals: {<br/>      traceFile: 'tb_top.m_top_wrapper.trace_file', &lt;---- change tb_top.m_top_wrapper to your path for this and next four.<br/>      globalTimeStamp: 'tb_top.m_top_wrapper.global_counter', <br/>      sampleTime: 2500,<br/>      traceOn: 'tb_top.m_top_wrapper.traceOn',<br/>      closeTrace: 'tb_top.m_top_wrapper.closeTrace',<br/>      globalClk: 'tb_top.m_top_wrapper.mainRegime_Cm_root_' &lt;---- You need a clock from the top gen_wrapper to use for global counter.<br/>    }<br/>  }<br/><br/>  return example_default; &lt;---- This changed<br/>}<br/><br/>function getTraceOnDefault () {<br/>  return true; &lt;---- This changed<br/>}<br/><br/>function getDumpTraceDefault () {<br/>  return &quot;1'b1&quot;; &lt;---- If you don't need a dump for every packet, you can change this to &quot;1'b0&quot;<br/>}</pre><h1 id="TraceInfrastructureProposal-TheGuts">The Guts</h1><p>For every switch when you turn on trace the following gets added</p><p style="margin-left: 30.0px;">real clk_count; // clocks since last reset</p><p>Per input:</p><p style="margin-left: 30.0px;">real iN_count; // number of times ready &amp;&amp; valid assert<br/>real ivN_count; // number of times valid asserts</p><p>Per output:</p><p style="margin-left: 30.0px;">real oN_count; // number of times ready &amp;&amp; valid assert<br/>real ovN_count; // number of times valid asserts</p><p>Were N can 0, 1, 2 to the number ports per direction.</p><p><br/></p>