<p>This document covers the topic of clock configuration in Maestro and expression of the intent in the generated RTL genwrapper json file</p><p> </p><div class="OutlineElement Ltr  BCX0 SCXW222350568"><p class="Paragraph SCXW222350568 BCX0"><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">T</span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">he </span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">internal </span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">clock object hierarchy in Maestro consists of 3 nested</span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0"> </span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">hierarchical levels:</span></span></p><p class="Paragraph SCXW222350568 BCX0"><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">1.<strong>clock region </strong></span></span><span class="LineBreakBlob BlobObject DragDrop SCXW222350568 BCX0"><span class="SCXW222350568 BCX0"> <br/></span>  Encompasses a <span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">collection of network elements (units) associated with one clock source coming from the outside of the system. The entire clock tree fed by this source is by default assumed balanced.</span></span><span class="EOP SCXW222350568 BCX0"> </span></span></p><p class="Paragraph SCXW222350568 BCX0"><span class="LineBreakBlob BlobObject DragDrop SCXW222350568 BCX0"><span class="EOP SCXW222350568 BCX0"> </span></span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">2. <strong>clock domain<br/></strong></span></span></p><div class="OutlineElement Ltr SCXW222350568 BCX0"><p class="Paragraph SCXW222350568 BCX0"><span class="TextRun SCXW222350568 BCX0">   A subset of a region,inherits region’s clock signal, which</span><span class="TextRun SCXW222350568 BCX0"> can be turned </span><span class="TextRun SCXW222350568 BCX0">off by an external agent called PMU. Gated clock domain assumes additional handshake between its units and outside world through PQchannell interface since all ongoing transactions must be completed before clock can be turned off by the PMU. </span></p><p class="Paragraph SCXW222350568 BCX0"><span class="TextRun SCXW222350568 BCX0"> </span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">3. <strong>clock </strong></span></span><strong><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">subdomain</span></span></strong><span class="EOP SCXW222350568 BCX0"> <br/>  Serves for the purpose of optional clock division. Can't be individually gated, this is done on domain level. </span>In the exported GW json each clock subdomain is translated to an instance of InterfaceCLK (<a class="external-link" href="https://confluence.arteris.com/display/ENGR/InterfaceCLK" rel="nofollow">confluence</a>, <a class="external-link" href="http://gitlab.arteris.com/hardware/hw-lib/blob/master/cpr/interface/InterfaceCLK.interface.cpr" rel="nofollow">git</a>) which is connected to all the units associated with the subdomain</p><div class="OutlineElement Ltr SCXW222350568 BCX0"><p class="Paragraph SCXW222350568 BCX0"><span class="TextRun SCXW222350568 BCX0"> </span><span class="EOP SCXW222350568 BCX0"> </span><span class="TextRun SCXW222350568 BCX0"><span class="NormalTextRun SCXW222350568 BCX0">In Maestro tcl language and the ADM every &quot;regular&quot; leaf level element, such as switch, must be associated with one subdomain.</span></span><span class="EOP SCXW222350568 BCX0"> Some special elements, such as clock adapters will be associated with two or even more clocks, but this is not yet supported. </span></p><p class="Paragraph SCXW222350568 BCX0"> </p></div></div></div><div class="OutlineElement Ltr SCXW222350568 BCX0"><p class="Paragraph SCXW222350568 BCX0">InterfaceCLK contains 2 signals, which are always present - clk and reset_n. Other signals are optional - test_en, clk_en, edge_en, pre_edge_en and retention_reset_n</p><p class="Paragraph SCXW222350568 BCX0"> </p><p class="Paragraph SCXW222350568 BCX0"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image confluence-external-resource" alt="ClockGateSignals.svg" src="https://confluence.arteris.com/download/attachments/11010857/ClockGateSignals.svg?version=1&amp;modificationDate=1562597392650&amp;api=v2" data-image-src="https://confluence.arteris.com/download/attachments/11010857/ClockGateSignals.svg?version=1&amp;modificationDate=1562597392650&amp;api=v2" loading="lazy"></span></p><p class="Paragraph SCXW222350568 BCX0">Their appearance in the verilog is configured through GW parameters created by Maestro out of the attributes  set with tcl commands. For ex clk_en signal won't appear in the clock interface unless its wClkEn param is set to 1 </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// hw-lib InterfaceCLK.interface.cpr
{
  &quot;name&quot;: &quot;clk_en&quot;,
  &quot;type&quot;: &quot;logic&quot;,
  &quot;dir&quot;: &quot;m_out&quot;,
  &quot;width&quot;: &quot;(params.wClkEn === undefined) ? 0 : params.wClkEn&quot;
}</pre>
</div></div><p class="Paragraph SCXW222350568 BCX0"><br/>Subsequently for a clock interface derived from subdomain, which is a child of gated clock domain, Maestro has to  create the following fragment in the generated GW json:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// top.level.rtl.gw.csr.json written from Maestro followed by mclient
{
  &quot;name&quot;: &quot;myClock&quot;,
  &quot;params&quot;: {&quot;wClkEn&quot;:1, ...},
  &quot;direction&quot;: &quot;slave&quot;,
  &quot;interface&quot;: &quot;InterfaceCLK&quot;
}</pre>
</div></div><p>In turn the value of wClkEn param should be calculated from the value of <strong><code>gating</code> </strong>parameter of Maestro clock domain object described in<a class="external-link" href="http://gitlab.arteris.com/maestro/maestro/blob/master/contrib/libmtypes/src/type_files/Ncore/premapping/COMMON_ClockDomainParam.json" rel="nofollow"> COMMON_ClockDomainParam.json</a> which can be either: <code>always_on</code>, <code>internal</code> and <code>external</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">&quot;gating&quot;: {
            &quot;kind&quot;: &quot;Variable&quot;,
            &quot;type&quot;: &quot;String&quot;,
            &quot;title&quot;: &quot;Gating&quot;,
            &quot;regex&quot;: &quot;&quot;,
            &quot;default&quot;: &quot;ERROR&quot;,
            &quot;enum&quot;: [
                &quot;ERROR&quot;,
                &quot;always_on&quot;,
                &quot;internal&quot;,
                &quot;external&quot;
            ],
            &quot;readOnly&quot;: false,
            &quot;userVisible&quot;: true
        },</pre>
</div></div><p><br/>When <code>gating</code> is set to <code>always_on or external</code>, clock enable is not needed inside our system and wClkEn should be either omitted from the clock interface params of GW json or set to 0. When gating is <code>internal</code> ,  wClkEn must be set to 1, which eventually results in  appearance of &lt;interface_name&gt;_clk_en signal as a primary input in generated verilog. </p><p>Finally Maestro Tcl language uses set_attribute command. Attribute names are identical to those in COMMON_ClockDomainParam.json </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">set clkdomain_a_0 [create_object -type clock_domain -name 0 -parent $clkregion_a]
set_attribute -object $clkdomain_a_0 -name gating -value external</pre>
</div></div><p> </p><p>Below are the formulas which attempt to show a derivation from various combinations of TCL clock domain/subdomain attribute values to parameter values in generated GW json file.</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Param</th><th class="confluenceTh">Comment/TODO</th></tr><tr><td class="confluenceTd">wClkEn = (clkDomain.gating == 'internal') ? 1 : 0;</td><td rowspan="2" class="confluenceTd">In external gating style clock is formed outside and we do not need to pass enables in except test enable which should suppress any possible clock gating inside the system.</td></tr><tr><td class="confluenceTd">wTestEn = (clkDomain.gating == 'internal' || clkDomain.gating == 'external') ? 1 : 0;</td></tr><tr><td class="confluenceTd">wEdgeEn = (clkDomain.gating == 'external' &amp;&amp; clkSubdomain.divide_by != 1) ? 1 : 0;</td><td class="confluenceTd"><p>Rename subdomain <code>divideby</code> attr to <code>divide_by</code>. Need to be user friendly since it's exposed in tcl<br/>In my understanding with internal gating style, the divider is incorporated inside the gater cell and thus we do not need edge enable signal. To be checked with John.</p></td></tr><tr><td class="confluenceTd">wPreEdgeEn = ???</td><td class="confluenceTd">Probably requires new subdomain attr. Is it even needed in 3.0 release? To be discussed with John</td></tr><tr><td colspan="1" class="confluenceTd">wRetRst =  (clkDomain.retention_reset == 1) ? 1 : 0; </td><td colspan="1" class="confluenceTd">Need to introduce new subdomain attribute retention_reset</td></tr></tbody></table></div><p><br/>Internal gating style of the clock domain should also trigger instantiation of a clock gater unit  in GW json. Its input is InterfaceCLK with all the needed parameters, while its output doesn't need to have any enable signals. Thus all *En params applied to output clock interface of the gater should be set to 0.                                                   </p><p> </p></div>