<h2 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-Primaryobjectivesanddifferencesvstheoldsystem:">Primary objectives and differences vs the old system:</h2><ul><li>Allow independent product build and testing from multiple independent code streams<br/>Ncore3 and master branches at this moment</li><li>Client-server consistency <br/>Each built Maestro product image consists of client and server parts which were tested with each other</li><li>Only packaged maestro-server (single binary) is supported<br/>Frankenstein source based flow is gone</li><li>Much better version control and debug-ability<br/>manifest.json shows the exact composition of the product image<br/>can run and compare older images<br/>change.log shows all commits made to image N vs N-1</li><li>Build product asynchronously whenever there is a code change either on the server or client side<br/>Smaller increments between builds </li></ul><h2 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-Jenkinspipelines">Jenkins pipelines</h2><p>Every active branch has a pipeline group associated with it. Here are <a class="external-link" href="http://jenkins.arteris.com:8080/job/Maestro/job/Ncore3/" rel="nofollow">Ncore3 </a>and <a class="external-link" href="http://jenkins.arteris.com:8080/job/Maestro/job/master/" rel="nofollow">master </a>groups, their structure is the same</p><p>Each group has 3 main pipelines which together build Maestro product image</p><p><a class="external-link" href="http://jenkins.arteris.com:8080/job/Maestro/job/master/job/Maestro-Client-Release/" rel="nofollow">Maestro-Client-Release</a> \<br/>                                         =&gt;<a class="external-link" href="http://jenkins.arteris.com:8080/job/Maestro/job/master/job/Maestro-Test/" rel="nofollow"> Maestro-Test</a><br/><a class="external-link" href="http://jenkins.arteris.com:8080/job/Maestro/job/master/job/Maestro-Server/" rel="nofollow">Maesto-Server</a>               / </p><p>Client pipeline fires when there is a push if maestro client repo on master branch. Server pipeline fires when there is a push to one of the repos from which maestro-server is composed - such as hw-sym, hw-lib, utils, m-ncore, etc.</p><p>Maestro-Test is launched whenever client or server pipeline successfully completes. It puts client and server execs side by side in the deployment area and runs few stages of tests. At the moment maestro flow_tests and Ncore DV checkin_test</p><h2 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-Productimagedeploymentareas">Product image deployment areas</h2><p>Maestro-Test creates product images under /engr/dev/releases/maestro/build/<strong>$branchName</strong>/maestro-product/<strong>$buildId</strong></p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="700" src="https://arterisip.atlassian.net/wiki/download/attachments/16164167/image2021-2-26_16-27-42.png?api=v2"></span><br/>There are 3 types of builds</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-thumbnail" height="150" src="https://arterisip.atlassian.net/wiki/download/attachments/16164167/image2021-2-26_16-23-53.png?api=v2"></span></p><p>1. &quot;Instant&quot; builds, like 264 - the number is Jenkins job id<br/>2. stable and bleeding_edge links. If stable is behind bleeding_edge it means that either fresh bleeding_edge is still being tested or there is a test failure<br/>3  daily builds, like 2021-02-25. We simply grab the stable by the end of the day and copy it</p><h2 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-Usefulutilities">Useful utilities</h2><p>We deploy them to /engr/dev/releases/maestro/build/tools and at the moment they only work in bash shell. If you use other shells, simply type 'bash' first.</p><h3 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-setup_maestro-&quot;choosing&quot;productimages">setup_maestro -&quot;choosing&quot; product images</h3><p>Useful for: PEs, AEs, DV, HW  <br/><br/>This utility helps you to quickly select desired Maestro product image to run. After selection you can simply run maestro or run_maestro and it will use the specified image (client and server) <br/><br/>First add this line to  ~/.bash_profile</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">alias setup_maestro=&#39;source /engr/dev/releases/maestro/build/tools/setup_maestro&#39;</pre>
</div></div><p class="auto-cursor-target">To see all options do setup_maestro -h</p><div class="code panel pdl" style="border-width: 1px;">
 <div class="codeHeader panelHeader pdl hide-border-bottom">
  <b class="code-title"></b><span class="collapse-source expand-control" style="display:none;"><span class="expand-control-icon icon">&nbsp;</span><span class="expand-control-text">Expand source</span></span><span class="collapse-spinner-wrapper"></span>
 </div>
 <div class="codeContent panelContent pdl hide-toolbar">
  <pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence; collapse: true" data-theme="Confluence">This script sets environment for running desired Maestro product image

There are two mutually exclusive ways to do that:
  1. Centrally deployed images are selected with a combination of 
   --branch_name and --build_id flags
  2. Custom build images are chosen with --build_dir flag   

Valid branches:
  master Ncore3  

To find a list of available builds from the central deployment area:
  ls /engr/dev/releases/maestro/build/&lt;branch_name&gt;/maestro-product 

Options: 
  -br|--branch_name &lt;BRANCH_NAME&gt;  Use maestro product image (client+server) from this branch. Default - master
  -bu|--build_id &lt;BUILD_ID&gt;        Use this version of maestro product image. Default - stable
  -bd|--build_dir &lt;PATH&gt;           Take custom Maestro product image from this directory
  -lk|--lock_build                 If build_id is a "moving target" stable or bleeding_edge, use actual build ID 
                                    it points to. Default - false
  -si|--show_info                  Don't change anything, only show what is the current setup in this shell                 
  -h                               Display this help page

Examples:
  1. All defaults - stable build from master branch
    setup_maestro 
  2. Choose a specific build from the master branch: 
    setup_maestro -br master -bu 798
  3. Choose custom product image:
    setup_maestro -bd ~/custom_image/2021_02_11_12_31_47
</pre>
 </div>
</div><p class="auto-cursor-target">To setup your environment so 'stable' image from the 'master' branch will be picked - simply do <strong>setup_maestro</strong><br/>you will see the following prompt</p><div class="code panel pdl" style="border-width: 1px;">
 <div class="codeHeader panelHeader pdl hide-border-bottom">
  <b class="code-title"></b><span class="collapse-source expand-control" style="display:none;"><span class="expand-control-icon icon">&nbsp;</span><span class="expand-control-text">Expand source</span></span><span class="collapse-spinner-wrapper"></span>
 </div>
 <div class="codeContent panelContent pdl hide-toolbar">
  <pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence; collapse: true" data-theme="Confluence">1.You have selected following Maestro product image:
  branch: master build_id: 885 timestamp: "2021-02-26 10:52:53 PST"
  client: /engr/dev/releases/maestro/build/master/maestro-product/stable/bin/maestro (build_id 272)
  server: /engr/dev/releases/maestro/build/master/maestro-product/stable/maestro-server/maestro-server (build_id 915)

  Testing status: PASSED  
  See manifest.json (git shas of all product repos) and changes.log (list of checkins since previous build) here: 
    http://jenkins.arteris.com:8080/job/Maestro/job/master/job/Maestro-Test/885
    
2.Important env vars:
  $MAESTRO_HOME=/engr/dev/releases/maestro/build/master/maestro-product/stable/maestro-client
  $MAESTRO_TCLLIB=/engr/dev/releases/maestro/build/master/maestro-product/stable/maestro-client/tests/cases/test_tcl/tcllib
  $MAESTRO_EXAMPLES=/engr/dev/releases/maestro/build/master/maestro-product/stable/hw_repos/test_projects/ncore_configs/base_configs

3.To generate RTL for

 a. one small Ncore config:
  maestro -c -s $MAESTRO_EXAMPLES/hw_config_02/hw_config_02.tcl

 b. one small Symphony config:
  maestro -c -s $MAESTRO_HOME/tests/cases/test_tcl/hw_config_sym/hw_config_sym_05/samsung_1x1_downsizer.tcl

4.To run verilator check on generated RTL:
  verilator --lint-only --error-limit 0 -Wall -Wno-UNUSED -Werror-UNDRIVEN -Ioutput/rtl/design output/rtl/design/gen_wrapper.v

5.To run simulation for one Symphony test:
    * assuming that you have already run /engr/dev/releases/maestro/build/tools/setup_sym in $PWD
  runsim -l maes_build -c samsung_1x1_downsizer</pre>
 </div>
</div><p class="auto-cursor-target"> you can change this setting as many times as you need in the same shell. For ex to switch to daily build 2021-02-23 on master:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">setup_maestro -bu 2021-02-23</pre>
</div></div><p class="auto-cursor-target">or to use bleeding_edge from Ncore3</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">setup_maestro -bu 2021-02-23</pre>
</div></div><p class="auto-cursor-target">Notice that stable and bleeding_edge builds can change &quot;under your feet&quot;. You can use --lock_build to prevent this</p><h3 class="auto-cursor-target" id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-run_flow_tests">run_flow_tests </h3><p class="auto-cursor-target">Useful for: SW team</p><p class="auto-cursor-target">Quickly runs all Ctest tcl scripts with selected Maestro. Client can be taken from a private unix area</p><div class="code panel pdl" style="border-width: 1px;">
 <div class="codeHeader panelHeader pdl hide-border-bottom">
  <b class="code-title"></b><span class="collapse-source expand-control" style="display:none;"><span class="expand-control-icon icon">&nbsp;</span><span class="expand-control-text">Expand source</span></span><span class="collapse-spinner-wrapper"></span>
 </div>
 <div class="codeContent panelContent pdl hide-toolbar">
  <pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence; collapse: true" data-theme="Confluence">  This script runs all maestro flow (aka Ctest) tests for the specified product image 
  Please run it from a new directory as it creates, or updates if exists, a massive 
  dir tree under $PWD/tests

  Usage: run_flow_tests
    -br|--branch_name &lt;BRANCH_NAME&gt;  
      Use maestro product image (client+server) from this branch   
      Default - master
    -bu|--build_id &lt;BUILD_ID&gt;        
      Use this version of maestro product image
      Default - stable
    -mcl|--maestro_client_home &lt;PATH&gt;        
      Override MAESTRO_HOME to pick a custom maestro client, either from deployment area
      or developer sandbox
    -drn|--dry_run
      Only print which maestro client and server will be taken and exit without runnign tests   
    -h       
      Display this help page

</pre>
 </div>
</div><p class="auto-cursor-target">Examples:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">  # Run tests for bleeding_edge  image of Ncore3 branch
  run_flow_tests -br Ncore3 -bu bleeding_edge

  # Ncore3 branch, image 138
  run_flow_tests -br Ncore3 -bu 138

  # Private Ncore client build paired with server from Ncore3 stable build
  run_flow_tests -br Ncore3 -bu stable -mcl ~/source_code/maestro
 
  # Private Ncore client build paired with server from Ncore3 image 138
  run_flow_tests -br Ncore3 -bu 138 -mcl ~/source_code/maestro</pre>
</div></div><h3 id="CopyofMaestromulti-branchbuildsystemandrelatedutilities-build_custom_product_image.js">build_custom_product_image.js</h3><p>Useful for: HW and DV teams</p><p>1. builds custom maestro-server<br/>2. installs it along with specified maestro-client to create a full product image<br/>3. sets up an environment so when maestro/run_maestro launched in the same unix shell<br/>it will use the custom image</p><p>Options:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[options]

Options:
-V, --version output the version number
-br|--branch_name &lt;name&gt; First half of base line. Server repos and client binary are taken from this branch by default (default: &quot;master&quot;)
-img|--image_id &lt;name&gt; Second half of base line. Client binary and server source code are taken from this particular product image
(default: &quot;stable&quot;)
-mcl|--maestro_client_home &lt;path&gt; Copy Maestro client from this build directory rather than from central deployment area
-hwn|--hw_ncr &lt;path&gt; Path to directory with hw-ncr source code
-hws|--hw_sym &lt;path&gt; Path to directory with hw-sym source code
-hwl|--hw_lib &lt;path&gt; Path to directory with hw-lib source code
-hwc|--hw_ccp &lt;path&gt; Path to directory with hw-ccp source code
-swu|--utils &lt;path&gt; Path to directory with utils source code
-bd|--build_dir &lt;path&gt; New directory where custom image will be created, (default: /home/bennyw/source_code/maestro/&lt;timestamp&gt;)
-drn|--dry_run Only print what will be taken from where and exit (default: false)
-h, --help display help for command</pre>
</div></div><p><br/></p><p>Examples:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Create product image equivalent to Ncore3 stable:
build_custom_product_image.js --branch_name Ncore3

Create image equivalent to Ncore3 build 157 (See list of available Ncore3 images under /engr/dev/releases/maestro/build/Ncore3/maestro-product)
build_custom_product_image.js --branch_name Ncore3 --image_id 157

Same, but take hw-ncr from private directory
build_custom_product_image.js --branch_name Ncore3 --image_id 157 --hw_ncr ~/source_code/hw-ncr</pre>
</div></div><p><br/></p><p><br/></p>