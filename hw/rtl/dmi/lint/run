#!/bin/csh

set TOTAL = `grep -RI "node" $WORK_TOP/dv/dmi/tb/testlist | grep -v "\-t" | grep -v "#" | wc -l`
set UNIT = `grep -RI "node" $WORK_TOP/dv/dmi/tb/testlist | grep -v "\-t" | grep -v "#" | awk '{print $6}'`
set NAME = `grep -RI "node" $WORK_TOP/dv/dmi/tb/testlist | grep -v "\-t" | grep -v "#" | awk '{print $9}'`
set CONFIG = `grep -RI "node" $WORK_TOP/dv/dmi/tb/testlist | grep -v "\-t" | grep -v "#" | awk '{print $13}'`

make clean

if ($1 != "run_only") then

rm -rf testlist
touch testlist

@ i = 1
while ($i <= $TOTAL)

    echo "node ../../../dv/scripts/rsim.js -m -a -e $UNIT[$i] -c -n $NAME[$i] -d RTL_DUT,INHOUSE_AXI,ASSERT_ON,DUMP_ON,V1,INHOUSE_OCP_VIP -r -C $CONFIG[$i]" >> testlist
    @ i++

end

tclsh ../../../dv/scripts/par_run.tcl -m 3 -e . -f testlist

endif

if ($1 != "compile_only") then

@ i = 1
while ($i <= $TOTAL)

    make spyglass NAME=$NAME[$i] FILE=../../../../debug/$UNIT[$i]/$NAME[$i]/rtl/\*.v FILE2=../../../../debug/$UNIT[$i]/$NAME[$i]/memory/\*.v WAIVER=../scripts/waivers.swl
    @ i++

end

endif

rm -rf lint_dmi.js
touch lint_dmi.js

echo "'use strict';" >> lint_dmi.js
echo "var exec = require('child_process').exec," >> lint_dmi.js
echo "expect = require('chai').expect;" >> lint_dmi.js
echo "describe('DMI Lint Report', function () {" >> lint_dmi.js

@ i = 1
while ($i <= $TOTAL)

    echo "it('DMI Lint $NAME[$i]', function (done) {" >> lint_dmi.js
    echo "exec('grep -RI "\"Error \"" rtl/dmi/lint/lint.$NAME[$i]/lint/consolidated_reports/lint_lint_rtl/moresimple.rpt | wc -l', function (e, sto1, ste1) {" >> lint_dmi.js
    echo "expect(sto1).to.equal('0\\n');" >> lint_dmi.js
    echo "done();" >> lint_dmi.js
    echo "});" >> lint_dmi.js
    echo "});" >> lint_dmi.js
    @ i++

end

echo "});" >> lint_dmi.js
