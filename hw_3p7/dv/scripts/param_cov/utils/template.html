<!DOCTYPE html>
<!--
--------------------------------------------------------------------------------------
 Copyright(C) 2014-2024 Arteris, Inc. and its applicable subsidiaries.
 All rights reserved.

 Disclaimer: This release is not provided nor intended for any chip implementations, tapeouts, or other features of production releases. 

 These files and associated documentation is proprietary and confidential to
 Arteris, Inc. and its applicable subsidiaries. The files and documentation
 may only be used pursuant to the terms and conditions of a signed written
 license agreement with Arteris, Inc. or one of its subsidiaries.
 All other use, reproduction, modification, or distribution of the information
 contained in the files or the associated documentation is strictly prohibited.
 This product and its technology is protected by patents and other forms of 
 intellectual property protection.
--------------------------------------------------------------------------------------
Version history:
0.1.0 - Initial commit against CONC-14332 3.7/develop
0.1.1 - formatting and typo fixes, moved file count into coverage json, html template updates, 
        add todo list output, WIP new Json merge
0.1.2 - Randomizer parameter coverage supported (just point to proper reference
        and input file types), still WIP new raw Json merge
0.1.3 - Account for strings as numbers (randomizer), Use new format for top.level.dv.json
        merge new raw Json data into existing still WIP
0.1.4 - more error handling
0.1.5 - adapt to interim random json
0.1.6 - fix html template, fix help with no options, put functions in file, handle hex values
0.1.7 - fix found values in summary, preliminary merge code, updated some ref params
0.2.0 - first merge release, fixed results (found values, hex, ranges), added data to outputs
0.2.1 - hex and ranges work properly, mereg fixes for hex and boolean, 
        data updates to reference_parameters.json, template.html improvements
0.2.2 - final fix for booleans in all cases
0.2.3 - formatting fixes, reference_parameters.json AIU and CLOCK updates
0.2.4 - ChiAiu reference values, empty values allowed in some cases

This file contains the html template for reporting results
-->
<html>

<head>
    <title>Ncore Parameter Coverage</title>
    <style>
        /*                      */
        /* Page formats         */
        /*                      */
        .column {
            float: left;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        /* cell backgrounds */
        .green-background {
            background-color: green;
        }

        .red-background {
            background-color: red;
        }

        .yellow-background {
            background-color: yellow;
        }

        /*                      */
        /* Table formats        */
        /*                      */
        #table1 td {
            /* width: 600px; */
            border: 1px solid #ddd;
            padding: 8px;
        }

        #summaryTable td {
            /* width: 200px; */
            border: 1px solid #ddd;
            padding: 8px;
        }

        /*                      */
        /* Table header formats */
        /*                      */
        #table1 th {
            background-color: #454745;
            color: white;
            text-align: center;
            padding: 10px;
        }

        #summaryTable th {
            /* background-color: #454745;
            color: white; */
            text-align: left;
            padding: 2px;
        }

        /* Summary Table Formats */
        /*                      */
        /* Table row formats    */
        /*                      */
        /* #summaryTable tr:hover {background-color: #f5f5f5;} */
        /*                      */
        /* Table column formats */
        /*                      */
        /* Block       */
        #summaryTable th:nth-child(1),
        #summaryTable td:nth-child(1) {
            width: 10px;
        }

        /* Found       */
        #summaryTable th:nth-child(2),
        #summaryTable td:nth-child(2) {
            width: 10px;
            text-align: right;
        }

        /* Not Fount   */
        #summaryTable th:nth-child(3),
        #summaryTable td:nth-child(3) {
            width: 10px;
        }

        /* Illegal     */
        #summaryTable th:nth-child(4),
        #summaryTable td:nth-child(4) {
            width: 10px;
        }

        /* Coverage    */
        #summaryTable th:nth-child(5),
        #summaryTable td:nth-child(5) {
            width: 10px;
        }

        /*                            */
        /* Param Table row formats    */
        /*                            */
        #table1 tr:hover {
            background-color: #f5f5f5;
        }

        /*                      */
        /* Table column formats */
        /*                      */
        /* Parameter     */
        #table1 th:nth-child(1),
        #table1 td:nth-child(1) {
            width: 100px;
        }

        /* Coverage      */
        #table1 th:nth-child(2),
        #table1 td:nth-child(2) {
            width: 40px;
            text-align: right;
        }

        /* Found         */
        #table1 th:nth-child(3),
        #table1 td:nth-child(3) {
            width: 175px;
        }

        /* Not Found     */
        #table1 th:nth-child(4),
        #table1 td:nth-child(4) {
            width: 175px;
        }

        /* Illegal       */
        #table1 th:nth-child(5),
        #table1 td:nth-child(5) {
            width: 100px;
        }

        footer {
            text-align: center;
            padding: 5px;
        }
    </style>
</head>

<body>

    <h2>Ncore Parameter Coverage</h2>

    <div class="row">
        <div class="column" style="background-color:#8db7e2;">
            <h2>Global</h2>
            <div id="summaryData"></div>
            </p>
            <div id="globalSummaryTable"></div>
        </div>

        <div class="column" style="background-color:#bbb;">
            <select id="dropdown1" onchange="updateTableAndDropdown()">
                <option value="all">ERROR</option> <!-- this is here in case error loading data -->
            </select><b>&nbsp;Block Parameters</b></p>
            <div id="rightSummaryTable"></div>
            </p>
            <select id="dropdown2" onchange="filterTable()">
                <option value="all">ERROR</option> <!-- this is here in case error loading data -->
            </select>
            <input type="text" id="searchInput" onkeyup="searchFunction()" placeholder="Search table..">
            <div id="mainTable">
                <table id="table1">
                </table>
            </div>
        </div>
    </div>

    <script>

        const crNotice = "(C) Arteris 2024 -- Proprietary and Confidential"
        var footer = document.createElement( "footer" )
        footer.innerHTML = crNotice
        document.body.appendChild( footer )

        // searches all cells
        function searchFunction() {
            var input, filter, table, tr, i, j, td, txtValue
            input = document.getElementById( "searchInput" )
            filter = input.value.toUpperCase()
            table = document.getElementById( "table1" )
            tr = table.getElementsByTagName( "tr" )
            for ( i = 1; i < tr.length; i++ ) {
                tr[ i ].style.display = "none"  // Start by hiding the row
                td = tr[ i ].getElementsByTagName( "td" )
                for ( j = 0; j < td.length; j++ ) {
                    if ( td[ j ] ) {
                        txtValue = td[ j ].textContent || td[ j ].innerText
                        if ( txtValue.toUpperCase().indexOf( filter ) > -1 ) {
                            tr[ i ].style.display = ""  // If match is found in any cell, display the row
                            break  // No need to check other cells; break out of the inner loop
                        }
                    }
                }
            }
        }

        function sortTable( n ) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0
            table = document.getElementById( "table1" )
            switching = true
            // Set the sorting direction to ascending:
            dir = "asc"
            /* Make a loop that will continue until
            no switching has been done: */
            while ( switching ) {
                // Start by saying: no switching is done:
                switching = false
                rows = table.rows
                /* Loop through all table rows (except the
                first, which contains table headers): */
                for ( i = 1; i < ( rows.length - 1 ); i++ ) {
                    // Start by saying there should be no switching:
                    shouldSwitch = false
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[ i ].getElementsByTagName( "TD" )[ n ]
                    y = rows[ i + 1 ].getElementsByTagName( "TD" )[ n ]
                    /* Check if the two rows should switch place,
                    based on the direction, asc or desc: */
                    if ( dir == "asc" ) {
                        if ( x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() ) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true
                            break
                        }
                    } else if ( dir == "desc" ) {
                        if ( x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase() ) {
                            // If so, mark as a switch and break the loop:
                            shouldSwitch = true
                            break
                        }
                    }
                }
                if ( shouldSwitch ) {
                    /* If a switch has been marked, make the switch
                    and mark that a switch has been done: */
                    rows[ i ].parentNode.insertBefore( rows[ i + 1 ], rows[ i ] )
                    switching = true
                    // Each time a switch is done, increase this count by 1:
                    switchcount++
                } else {
                    /* If no switching has been done AND the direction is "asc",
                    set the direction to "desc" and run the while loop again. */
                    if ( switchcount == 0 && dir == "asc" ) {
                        dir = "desc"
                        switching = true
                    }
                }
            }
        }

        function getFilename() {
            var path = window.location.pathname
            var page = path.split( "/" ).pop()
            var filename = page.substring( 0, page.lastIndexOf( "." ) )
            return filename
        }

        let thisFile = getFilename()

        fetch( `${ thisFile }.json` )
            .then( response => response.json() )
            .then( data => {
                localStorage.setItem( "incoming", JSON.stringify( data ) )
                loadData( JSON.parse( localStorage.getItem( "incoming" ) ) )
            } )
            .catch( error => console.error( 'Error fetching data:', error ) )

        // globalize data from fetch and then initialize the left side on page
        // load or refresh
        function loadData( dta ) {
            data = dta
            updateUnitDropdown()
            createGlobalSummaryTable() // Global
            // createSummaryTable();       // Block
        }

        function createGlobalSummaryTable() {

            // Get the left column element
            var leftColumn = document.querySelector( '.column' )

            // Create a new table
            var table = document.createElement( 'table' )
            table.id = 'summaryTable'

            // Create the table headers
            var headers = [ 'Block', 'Parms', 'Fnd', 'Not Fnd', 'Ill', 'Cov' ]
            var thead = table.createTHead()
            var headerRow = thead.insertRow( 0 )
            for ( var h = 0; h < headers.length; h++ ) {
                var th = document.createElement( 'th' )
                th.innerHTML = headers[ h ]
                headerRow.appendChild( th )
            }

            var numParam = 0

            function expandRange( range ) {
                let [ start, end ] = range.split( ':' ).map( Number )
                return Array( end - start + 1 ).fill().map( ( _, idx ) => start + idx )
            }
            // For each key, calculate the counts and create a new row in the table
            for ( var key in data ) {
                if ( key === "numFiles" ) { // numFiles is not coverage data
                    numFiles = data[ key ]
                    continue
                } else if ( key === "ignoredKeys" ) {
                    ignoredKeys = data[ key ]
                    continue
                }
                var row = table.insertRow( -1 )

                var foundCount = 0
                var notFoundCount = 0
                var foundIllegalCount = 0
                var keyParams = 0
                for ( param in data[ key ] ) {
                    foundCount += data[ key ][ param ][ "foundValues" ].count
                    notFoundCount += data[ key ][ param ][ "notFoundValues" ].count
                    foundIllegalCount += data[ key ][ param ][ "foundIllegal" ].count
                    numParam += 1
                    keyParams += 1
                }

                // if (!((key === "Chiaiu" | key === "Ioaiu") & foundCount == 0)) {
                var coverage = ( foundCount / ( foundCount + notFoundCount ) * 100 ).toFixed( 2 ) + "%"
                var cell1 = row.insertCell( 0 )
                cell1.innerHTML = key
                var cell2 = row.insertCell( 1 )
                cell2.innerHTML = keyParams
                var cell3 = row.insertCell( 2 )
                cell3.innerHTML = foundCount
                var cell4 = row.insertCell( 3 )
                cell4.innerHTML = notFoundCount
                var cell5 = row.insertCell( 4 )
                cell5.innerHTML = foundIllegalCount
                var cell6 = row.insertCell( 5 )
                cell6.innerHTML = coverage
                // }
            }

            // Append the table to the left column
            leftColumn.appendChild( table )

            // Create a new paragraph element for the static list of ignored items
            var para = document.createElement( "pre" )
            para.style = "white-space: pre;"
            para.appendChild( document.createTextNode( "Ignored Items:\n\n" ) )
            for ( item in ignoredKeys ) {
                para.appendChild( document.createTextNode( ignoredKeys[ item ] + "\n" ) )
            }
            para.appendChild( document.createTextNode( "\n\n" + crNotice ) )

            // Append the static text after the table
            leftColumn.appendChild( para )

            // Calculate the sums and percentage
            var sumFound = 0
            var sumNotFound = 0
            var sumIllegal = 0
            for ( var i = 1; i < table.rows.length; i++ ) {
                var row = table.rows[ i ]
                sumFound += Number( row.cells[ 2 ].innerHTML )
                sumNotFound += Number( row.cells[ 3 ].innerHTML )
                sumIllegal += Number( row.cells[ 4 ].innerHTML )
            }
            var total = sumFound + sumNotFound + sumIllegal
            var percentage = ( sumFound / ( sumFound + sumNotFound ) ) * 100

            // Create the additional data
            var additionalDataDiv = document.getElementById( "summaryData" )

            additionalDataDiv.innerHTML = ""  // Clear the previous additional data, if any
            additionalDataDiv.innerHTML += crNotice + "<br><br>"
            additionalDataDiv.innerHTML += "<b>Input Files: </span>" + numFiles + "</b><br>"
            additionalDataDiv.innerHTML += "<b>Total Parameters: </span>" + numParam + "</b><br><br>"
            additionalDataDiv.innerHTML += "<b>Values Found: </span>" + sumFound + "</b><br>"
            additionalDataDiv.innerHTML += "<b>Values Not Found: " + sumNotFound + "</b><br>"
            additionalDataDiv.innerHTML += "<b>Illegal Values: " + sumIllegal + "</b><br>"
            additionalDataDiv.innerHTML += "<b>Coverage: " + percentage.toFixed( 2 ) + "%</b><br>"
        }

        // populate the left side (units) then call right side (parameters)
        function updateUnitDropdown() {
            var dropdownUnit = document.getElementById( "dropdown1" )
            dropdownUnit.innerHTML = ""
            var option = document.createElement( "option" )
            let unitList = Object.keys( data )
            let _ = unitList.pop() // remove numFiles from keys
            var idx = 0
            for ( var i = 0; i < unitList.length; i++ ) {
                // if (!((unitList[i] === "Chiaiu" | unitList[i] === "Ioaiu") & data[unitList[i].foundCount] == 0)) {
                var option = document.createElement( "option" )
                option.text = unitList[ i ]
                option.value = unitList[ i ]
                dropdownUnit.add( option )
                // }
            }
            updateTableAndDropdown()
        }

        var allRows = []   // Global variable to store rows

        // populate the right side (parameters)
        function updateTableAndDropdown() {
            allRows = []
            var selectedOption = document.getElementById( "dropdown1" ).value
            var paramList = []
            var tableData = []
            var idx = 0
            const selData = data[ selectedOption ]
            for ( key in selData ) {
                paramList[ idx ] = key
                tableData[ idx ] = selData[ key ]
                idx += 1
            }

            // Update table
            var table = document.getElementById( "table1" )
            table.innerHTML = ""

            // add table headers
            var headers = [ "Parameter", "Coverage", "Found", "Not Found", "Illegal" ]
            var thead = table.createTHead()
            var headerRow = thead.insertRow( 0 )
            for ( var h = 0; h < headers.length; h++ ) {
                var th = document.createElement( "th" )
                th.innerHTML = headers[ h ]
                th.onclick = ( function ( h ) {
                    return function () { sortTable( h ) }  // Use an IIFE to capture the current value of h
                } )( h )
                headerRow.appendChild( th )
            }

            // Create a tbody element
            var tbody = table.querySelector( "tbody" )
            if ( !tbody ) {
                // If there's no tbody element, create one
                tbody = table.createTBody()
            } else {
                // If there's an existing tbody element, clear it
                tbody.innerHTML = ""
            }

            // add table data
            for ( var i = 0; i < tableData.length; i++ ) {
                var tcell = ""
                var row = tbody.insertRow( i )
                var cell1 = row.insertCell( 0 )
                var cell2 = row.insertCell( 1 )
                var cell3 = row.insertCell( 2 )
                var cell4 = row.insertCell( 3 )
                var cell5 = row.insertCell( 4 )
                cell1.innerHTML = paramList[ i ]
                cell2.innerHTML = tableData[ i ].percentage + "%"
                cell3.innerHTML = String( Object.values( tableData[ i ].foundValues.values ) ).replaceAll( ',', ', ' )
                cell4.innerHTML = String( Object.values( tableData[ i ].notFoundValues.values ) ).replaceAll( ',', ', ' )
                cell5.innerHTML = String( Object.values( tableData[ i ].foundIllegal.values ) ).replaceAll( ',', ', ' )
                allRows.push( row.cloneNode( true ) ) // Store a copy of the row
            }

            // Update dropdown
            var dropdown = document.getElementById( "dropdown2" )
            dropdown.innerHTML = ""
            var option = document.createElement( "option" )
            option.text = "All"
            option.value = "all"
            dropdown.add( option )
            for ( var i = 0; i < tableData.length; i++ ) {
                var option = document.createElement( "option" )
                option.text = paramList[ i ]
                option.value = paramList[ i ]
                dropdown.add( option )
            }

            // Call the function to filter the table based on the new dropdown selection
            filterTable()
            createSummaryTable()  // Update parameter summary table when the left dropdown changes
        }


        function filterTable() {
            var dropdown = document.getElementById( "dropdown2" )
            var selectedOption = dropdown.value
            var table = document.getElementById( "mainTable" )
            var tbody = table.querySelector( "tbody" )
            for ( var i = 0; i < tbody.rows.length; i++ ) {
                var row = tbody.rows[ i ]
                var cellContent = row.cells[ 0 ].innerHTML
                var secondCell = row.cells[ 1 ]
                var fifthCell = row.cells[ 4 ]
                if ( selectedOption == "all" || cellContent == selectedOption ) {
                    row.style.display = ""
                    // Change the background color of the second cell based on its value
                    if ( parseInt( secondCell.innerHTML ) >= "75" && fifthCell.innerHTML.trim() === "" ) {
                        secondCell.classList.add( "green-background" )
                    } else if ( parseInt( secondCell.innerHTML ) >= "50" ) {
                        secondCell.classList.add( "yellow-background" )
                    }
                    else {
                        row.classList.add( "red-background" )
                    }
                } else {
                    row.style.display = "none"
                }
            }
        }

        function createSummaryTable() {
            // Get the selected option from the left dropdown
            var selectedOption = document.getElementById( "dropdown1" ).value
            var myData = data[ selectedOption ]

            // Calculate the values for the summary table
            var totalParameters = Object.keys( myData ).length
            var foundValues = 0
            var notFoundValues = 0
            var illegalValues = 0
            for ( var key in myData ) {
                foundValues += myData[ key ].foundValues.count
                notFoundValues += myData[ key ].notFoundValues.count
                illegalValues += myData[ key ].foundIllegal.count
            }
            var percentCovered = ( foundValues / ( foundValues + notFoundValues ) ) * 100

            // Create the summary table
            var table = document.createElement( "table" )
            var rows = [
                [ "total parameters", totalParameters ],
                [ "% values covered", percentCovered.toFixed( 2 ) + "%" ],
                [ "found values", foundValues ],
                [ "not found values", notFoundValues ],
                [ "illegal values", illegalValues ]
            ]
            for ( var i = 0; i < rows.length; i++ ) {
                var row = table.insertRow( i )
                var cell1 = row.insertCell( 0 )
                var cell2 = row.insertCell( 1 )
                cell1.innerHTML = rows[ i ][ 0 ]
                cell2.innerHTML = rows[ i ][ 1 ]
            }

            // Add the summary table to the right column
            var summaryTableDiv = document.getElementById( "rightSummaryTable" )
            summaryTableDiv.innerHTML = ""  // Clear the previous summary table, if any
            summaryTableDiv.appendChild( table )

            // Create a new paragraph element for the static text
            var para = document.createElement( "p" )
            var node = document.createTextNode( "NOTE: Sort by clicking column header.  Sorting can be VERY slow, be patient!" )
            para.appendChild( node )

            // Append the static text after the table
            summaryTableDiv.appendChild( para )
        }

    </script>
</body>

</html>
